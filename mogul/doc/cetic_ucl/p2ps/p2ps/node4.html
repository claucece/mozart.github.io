<!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.0 Transitional//EN">
<HTML><HEAD><TITLE>4 Tutorial Examples</TITLE><LINK href="ozdoc.css" rel="stylesheet" type="text/css"></HEAD><BODY><TABLE align="center" border="0" cellpadding="6" cellspacing="6" class="nav"><TR bgcolor="#DDDDDD"><TD><A href="node3.html#chapter.eventsmessages">&lt;&lt; Prev</A></TD><TD><A href="index.html">- Up -</A></TD><TD><A href="node5.html#chapter.install">Next &gt;&gt;</A></TD></TR></TABLE><DIV id="chapter.examples"><H1><A name="chapter.examples">4 Tutorial Examples</A></H1><P>In the following we present some simple examples that demonstrate a large part of the <CODE>P2PS</CODE> functionality. In order to use them, we import the <CODE>P2PS</CODE> library <CODE><SPAN class="string">'x-ozlib://cetic_ucl/p2ps/P2PS.ozf'</SPAN></CODE> in our applications. </P><H2><A name="label2">4.1 Three peer network</A></H2><P>This is an example of a P2P network of three peers (or nodes). It is composed of three files <CODE><SPAN class="string">'node1.oz'</SPAN></CODE>, <CODE><SPAN class="string">'node2.oz'</SPAN></CODE>, and <CODE><SPAN class="string">'node3.oz'</SPAN></CODE>, representing <CODE>node1</CODE>, <CODE>node2</CODE> and <CODE>node3</CODE>. Peers <CODE>node1</CODE> and <CODE>node2</CODE> connect to the network through <CODE>node1</CODE> and respectively <CODE>node2</CODE>. Then, <CODE>node3</CODE> sends a multicast message to <CODE>node1</CODE> and <CODE>node2</CODE>, and a one-to-one message to the responsible of key 42. This example runs directly in the OPI (Oz Programming Interface). </P><P>The first node of a P2P network is always &quot;special&quot;. Actually, it represents a network by itself. We create it with the method <CODE>createNet</CODE>. In our case, <CODE>node1</CODE> decides to work on port# 3001. Further, we run a loop to wait and show the messages sent to this node. </P><P class="margin"><A href="node1.oz">Source File</A></P><P> </P><BLOCKQUOTE><PRE><SPAN class="comment">%%&nbsp;node1&nbsp;%%<BR></SPAN><SPAN class="keyword">declare</SPAN>&nbsp;<BR>[P2PS]&nbsp;=&nbsp;{Module<SPAN class="keyword">.</SPAN>link&nbsp;[<SPAN class="string">'x-ozlib://cetic_ucl/p2ps/P2PS.ozf'</SPAN>]}<BR>MS<BR>&nbsp;<BR><SPAN class="comment">%&nbsp;Create&nbsp;first&nbsp;node&nbsp;(with&nbsp;id&nbsp;1)&nbsp;in&nbsp;a&nbsp;P2PS&nbsp;network.<BR>%&nbsp;Set&nbsp;the&nbsp;port#&nbsp;in&nbsp;the&nbsp;access&nbsp;point&nbsp;config&nbsp;to&nbsp;3001.<BR></SPAN>OP2PS&nbsp;=&nbsp;{New&nbsp;P2PS<SPAN class="keyword">.</SPAN>p2pServices<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;createNet(nodeConfig:&nbsp;nodeConfig(nodeId:1)<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;apConfig:apConfig(pn:3001)<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;msgStrm:MS)}<BR>&nbsp;<BR><SPAN class="comment">%&nbsp;Display&nbsp;each&nbsp;message&nbsp;received&nbsp;on&nbsp;the&nbsp;message&nbsp;stream.<BR></SPAN><SPAN class="keyword">thread</SPAN>&nbsp;<BR>&nbsp;&nbsp;&nbsp;<SPAN class="keyword">for</SPAN>&nbsp;M&nbsp;<SPAN class="keyword">in</SPAN>&nbsp;MS&nbsp;<SPAN class="keyword">do</SPAN>&nbsp;<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{Show&nbsp;M}<BR>&nbsp;&nbsp;&nbsp;<SPAN class="keyword">end</SPAN>&nbsp;<BR><SPAN class="keyword">end</SPAN>&nbsp;<BR></PRE></BLOCKQUOTE><P></P><P>We create <CODE>node2</CODE> with id 16. It joins the network via <CODE>node1</CODE> specifying the Ip address and port number of <CODE>node1</CODE>. Note the conversion address to access point. We assume the Ip and the port are known. One could have received the access point token of <CODE>node1</CODE> from another node or from <CODE>node1</CODE> itself. Otherwise, a cute way of obtaining am access point in a LAN is to use the <A href="http://www.mozart-oz.org/documentation/system/node51.html#chapter.discovery">Discovery</A> module of Mozart. Note the use of method <CODE>joinNet</CODE>. Further, we run a loop to wait and show the messages sent to this node. </P><P class="margin"><A href="node2.oz">Source File</A></P><P> </P><BLOCKQUOTE><PRE><SPAN class="comment">%%&nbsp;node&nbsp;2&nbsp;%%<BR></SPAN><SPAN class="keyword">declare</SPAN>&nbsp;<BR>[P2PS]&nbsp;=&nbsp;{Module<SPAN class="keyword">.</SPAN>link&nbsp;[<SPAN class="string">'x-ozlib://cetic_ucl/p2ps/P2PS.ozf'</SPAN>]}<BR>MS&nbsp;&nbsp;<BR>&nbsp;<BR><SPAN class="comment">%&nbsp;Build&nbsp;the&nbsp;access&nbsp;point&nbsp;token&nbsp;of&nbsp;a&nbsp;node&nbsp;(node1)&nbsp;in&nbsp;the&nbsp;P2PS&nbsp;network.<BR></SPAN>RAP&nbsp;=&nbsp;{P2PS<SPAN class="keyword">.</SPAN>address2ap&nbsp;<SPAN class="string">&quot;127.0.0.1&quot;</SPAN>&nbsp;3001}<BR>&nbsp;<BR><SPAN class="comment">%&nbsp;Create&nbsp;a&nbsp;node&nbsp;with&nbsp;id&nbsp;16&nbsp;and&nbsp;join&nbsp;the&nbsp;network,&nbsp;using&nbsp;the&nbsp;token&nbsp;RAP.<BR></SPAN>OP2PS&nbsp;=&nbsp;{New&nbsp;P2PS<SPAN class="keyword">.</SPAN>p2pServices<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;joinNet(remoteAP:&nbsp;&nbsp;&nbsp;RAP<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;nodeConfig:&nbsp;nodeConfig(nodeId:16)<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;apConfig:apConfig(pn:3002))}<BR>&nbsp;<BR><SPAN class="comment">%&nbsp;Get&nbsp;the&nbsp;message&nbsp;stream&nbsp;and&nbsp;display&nbsp;each&nbsp;received&nbsp;messages.<BR></SPAN><SPAN class="keyword">thread</SPAN>&nbsp;<BR>&nbsp;&nbsp;&nbsp;<SPAN class="keyword">for</SPAN>&nbsp;M&nbsp;<SPAN class="keyword">in</SPAN>&nbsp;{OP2PS&nbsp;getMsgStrm($)}&nbsp;<SPAN class="keyword">do</SPAN>&nbsp;<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{Show&nbsp;M}<BR>&nbsp;&nbsp;&nbsp;<SPAN class="keyword">end</SPAN>&nbsp;<BR><SPAN class="keyword">end</SPAN>&nbsp;<BR></PRE></BLOCKQUOTE><P></P><P>Finally, we create <CODE>node3</CODE> without specifying its <CODE>nodeId</CODE>; the node will be provided with a random id. This node chooses to join the system via <CODE>node2</CODE>, specifying its address and port number. Note that it could have chosen to join via any other node within the network, e.g., <CODE>node1</CODE>. Further on, it sends a one-to-one message to the responsible of key 42, and a multicast message to <CODE>node1</CODE> and <CODE>node2</CODE>. The following is the code implementing <CODE>node3</CODE>. </P><P class="margin"><A href="node3.oz">Source File</A></P><P> </P><BLOCKQUOTE><PRE><SPAN class="keyword">declare</SPAN>&nbsp;<SPAN class="comment">/*&nbsp;node3&nbsp;*/</SPAN>&nbsp;<BR>[P2PS]&nbsp;=&nbsp;{Module<SPAN class="keyword">.</SPAN>link&nbsp;[<SPAN class="string">'x-ozlib://cetic_ucl/p2ps/P2PS.ozf'</SPAN>]}<BR>&nbsp;<BR><SPAN class="comment">%&nbsp;Build&nbsp;the&nbsp;access&nbsp;point&nbsp;token&nbsp;of&nbsp;a&nbsp;node&nbsp;(here,&nbsp;node2)&nbsp;in&nbsp;the&nbsp;P2PS&nbsp;network.<BR></SPAN>RAP&nbsp;=&nbsp;{P2PS<SPAN class="keyword">.</SPAN>address2ap&nbsp;<SPAN class="string">&quot;127.0.0.1&quot;</SPAN>&nbsp;3002}<BR>&nbsp;<BR><SPAN class="comment">%&nbsp;Create&nbsp;a&nbsp;node&nbsp;and&nbsp;join&nbsp;the&nbsp;network,&nbsp;using&nbsp;the&nbsp;token&nbsp;RAP.<BR></SPAN>OP2PS&nbsp;=&nbsp;{New&nbsp;P2PS<SPAN class="keyword">.</SPAN>p2pServices&nbsp;joinNet(remoteAP:&nbsp;RAP)}<BR>&nbsp;<BR><SPAN class="comment">%&nbsp;Send&nbsp;a&nbsp;message&nbsp;to&nbsp;the&nbsp;responsible&nbsp;of&nbsp;key&nbsp;42.<BR></SPAN>{OP2PS&nbsp;send(dst:42&nbsp;msg:sasa&nbsp;toResp:<SPAN class="keyword">true</SPAN>)}<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<BR><SPAN class="comment">%&nbsp;Send&nbsp;a&nbsp;multicast&nbsp;message&nbsp;to&nbsp;nodes&nbsp;with&nbsp;id&nbsp;1&nbsp;and&nbsp;16.<BR></SPAN>{OP2PS&nbsp;multicast(dst:[1&nbsp;16]&nbsp;msg:hello)}<BR></PRE></BLOCKQUOTE><P></P><DIV id="section.exmpl.dictionary"><H2><A name="section.exmpl.dictionary">4.2 Adding dictionary primitives</A></H2><P>The previous example shows how to build up a P2P system and how the <CODE>P2PS</CODE> library can be used for message exchange between peers. This example can be enriched with dictionary operations such as <EM>putVal</EM> a value to a given key, and <EM>getVal</EM> a value corresponding to a given key (note that <EM>getVal</EM> corresponds to the <EM>lookup</EM> primitive). The key can be any integer ranging from 0 to <CODE>maxNetSize<SPAN class="keyword">-</SPAN>1</CODE>, i.e., the size of the virtual search space. The value can be any Oz value.</P><P>To form the distributed dictionary, we first add a local dictionary to each peer in the network. We also have a dictionary to be used to achieve synchronization with the <EM>getVal</EM> primitive. </P><BLOCKQUOTE class="code"><CODE>LclDict&nbsp;&nbsp;=&nbsp;{Dictionary<SPAN class="keyword">.</SPAN>new}<BR>TempDict&nbsp;=&nbsp;{Dictionary<SPAN class="keyword">.</SPAN>new}</CODE></BLOCKQUOTE><P> </P><P>The following two procedures implement the insertion and respectively the retrieval of a value to/from a distributed dictionary. The <EM>remove</EM> operation can be added similarly. </P><BLOCKQUOTE class="code"><CODE><SPAN class="keyword">proc</SPAN><SPAN class="variablename">&nbsp;</SPAN>{<SPAN class="functionname">PutVal</SPAN>&nbsp;<SPAN class="keyword">+</SPAN>Key&nbsp;<SPAN class="keyword">+</SPAN>Val}<BR>&nbsp;&nbsp;&nbsp;{OP2PS&nbsp;send(dst:Key&nbsp;msg:put(Key&nbsp;Val)&nbsp;toResp:<SPAN class="keyword">true</SPAN>)}<BR><SPAN class="keyword">end</SPAN>&nbsp;<BR>&nbsp;<BR><SPAN class="keyword">proc</SPAN><SPAN class="variablename">&nbsp;</SPAN>{<SPAN class="functionname">GetVal</SPAN>&nbsp;<SPAN class="keyword">+</SPAN>Key&nbsp;?Val}<BR>&nbsp;&nbsp;&nbsp;{OP2PS&nbsp;send(dst:Key&nbsp;msg:get(Key)&nbsp;toResp:<SPAN class="keyword">true</SPAN>)}<BR>&nbsp;&nbsp;&nbsp;{Dictionary<SPAN class="keyword">.</SPAN>put&nbsp;TempDict&nbsp;Key&nbsp;Val}<BR>&nbsp;&nbsp;&nbsp;{Wait&nbsp;Val}<BR><SPAN class="keyword">end</SPAN></CODE></BLOCKQUOTE><P> Inserting value <CODE><I>Val</I></CODE> at key <CODE><I>Key</I></CODE> into the distributed dictionary translates to storing <CODE><I>Val</I></CODE> at the node responsible of <CODE><I>Key</I></CODE>. Thus, the procedure <CODE>PutVal</CODE> simply sends the message <CODE>put</CODE> to the node responsible of <I>Key</I>. The <CODE>put</CODE> message contains the key and the value fields. Procedure <CODE>GetVal</CODE> sends the message <CODE>get</CODE> to the node responsible of <CODE><I>Key</I></CODE>. <CODE><I>Val</I></CODE> is temporary stored in <CODE>TempDict</CODE> and bound when we get the answer to the message <CODE>get</CODE> from the node responsible of <CODE><I>Key</I></CODE>. </P><P> Now, in order to be able to interpret these messages, we have to change a bit the loop that processes the incoming messages as follows. </P><BLOCKQUOTE class="code"><CODE><SPAN class="comment">%&nbsp;get&nbsp;the&nbsp;message&nbsp;stream&nbsp;and&nbsp;process&nbsp;each&nbsp;received&nbsp;message<BR></SPAN><SPAN class="keyword">thread</SPAN>&nbsp;<BR>&nbsp;&nbsp;&nbsp;<SPAN class="keyword">for</SPAN>&nbsp;M&nbsp;<SPAN class="keyword">in</SPAN>&nbsp;{OP2PS&nbsp;getMsgStrm($)}&nbsp;<SPAN class="keyword">do</SPAN>&nbsp;<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<SPAN class="keyword">case</SPAN>&nbsp;M&nbsp;<SPAN class="keyword">of</SPAN>&nbsp;rcvMsg(msg:Payload&nbsp;src:Src&nbsp;dst:_)&nbsp;<SPAN class="keyword">then</SPAN>&nbsp;<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<SPAN class="comment">%&nbsp;store&nbsp;the&nbsp;(key&nbsp;value)&nbsp;pair&nbsp;to&nbsp;the&nbsp;local&nbsp;dictionary<BR></SPAN>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<SPAN class="keyword">case</SPAN>&nbsp;Payload&nbsp;<SPAN class="keyword">of</SPAN>&nbsp;put(Key&nbsp;Val)&nbsp;<SPAN class="keyword">then</SPAN>&nbsp;<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{Dictionary<SPAN class="keyword">.</SPAN>put&nbsp;LclDict&nbsp;Key&nbsp;Val}&nbsp;&nbsp;&nbsp;&nbsp;<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<SPAN class="comment">%&nbsp;return&nbsp;the&nbsp;value&nbsp;corresponding&nbsp;to&nbsp;Key<BR></SPAN>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<SPAN class="keyword">[]</SPAN>&nbsp;get(Key)&nbsp;<SPAN class="keyword">then</SPAN>&nbsp;Val&nbsp;<SPAN class="keyword">in</SPAN>&nbsp;<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{Dictionary<SPAN class="keyword">.</SPAN>get&nbsp;LclDict&nbsp;Key&nbsp;Val}<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{OP2PS&nbsp;send(dst:Src&nbsp;msg:ret(Key&nbsp;Val)&nbsp;toResp:<SPAN class="keyword">true</SPAN>)}<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<SPAN class="comment">%&nbsp;receive&nbsp;the&nbsp;value&nbsp;at&nbsp;key&nbsp;Key<BR></SPAN>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<SPAN class="keyword">[]</SPAN>&nbsp;ret(Key&nbsp;Val)&nbsp;<SPAN class="keyword">then</SPAN>&nbsp;<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{Dictionary<SPAN class="keyword">.</SPAN>get&nbsp;TempDict&nbsp;Key&nbsp;Val}<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{Dictionary<SPAN class="keyword">.</SPAN>remove&nbsp;TempDict&nbsp;Key}&nbsp;&nbsp;<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<SPAN class="keyword">else</SPAN>&nbsp;<SPAN class="keyword">skip</SPAN>&nbsp;<SPAN class="keyword">end</SPAN>&nbsp;<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<SPAN class="keyword">else</SPAN>&nbsp;<SPAN class="keyword">skip</SPAN>&nbsp;<SPAN class="keyword">end</SPAN>&nbsp;<BR>&nbsp;&nbsp;&nbsp;<SPAN class="keyword">end</SPAN>&nbsp;<BR><SPAN class="keyword">end</SPAN></CODE></BLOCKQUOTE><P> If we receive message <CODE>put(Key&nbsp;Val)</CODE>, the value <CODE><I>Val</I></CODE> is stored at key <CODE><I>Key</I></CODE> in the local dictionary. If the message is <CODE>get(Key)</CODE>, the value corresponding to <I>Key</I> is returned with the message <CODE>ret(Key&nbsp;Val)</CODE>. If the message is <CODE>ret(Key&nbsp;Val)</CODE>, bind <CODE><I>Val</I></CODE> to the variable stored at key <CODE><I>Key</I></CODE> in <CODE>TempDict</CODE>. </P><P> Note that we assumed, for simplicity, that the network does not change, i.e., there is no node joining or leaving. A more complete example would include some redundancy and use the successors of a node as a backup for when the node would fail. </P></DIV><H2><A name="label3">4.3 Collaborative peers</A></H2><P>The code in <CODE><SPAN class="string">'clbpeer.oz'</SPAN></CODE> is a stand alone application implementing a peer node using the <CODE>P2PS</CODE> library. Alone, each node peer can be seen as a one-node P2P network. When another node connects to it we say we have a two nodes P2P network, and so forth. In this example, each peer node periodically announces (broadcast) its presence in the network. Other peers eventually notice this and build their own membership list (a list of known nodes). At each peer, the membership list is represented as a soft state (i.e., a state that has to be kept alive). The membership list is eventually updated each time a peer joins or leaves the network. </P><P class="margin"><A href="clbpeer.oz">Source File</A></P><P> </P><BLOCKQUOTE><PRE><SPAN class="keyword">functor</SPAN>&nbsp;<BR><SPAN class="keyword">import</SPAN>&nbsp;<BR>&nbsp;&nbsp;&nbsp;Application<BR>&nbsp;&nbsp;&nbsp;System<BR>&nbsp;<BR>&nbsp;&nbsp;&nbsp;P2PS&nbsp;<SPAN class="keyword">at</SPAN>&nbsp;<SPAN class="string">'x-ozlib://cetic_ucl/p2ps/P2PS.ozf'</SPAN>&nbsp;<BR><SPAN class="keyword">define</SPAN>&nbsp;<BR>&nbsp;&nbsp;&nbsp;RefreshTime&nbsp;&nbsp;=&nbsp;5<SPAN class="keyword">*</SPAN>1000&nbsp;<SPAN class="comment">%&nbsp;the&nbsp;time&nbsp;before&nbsp;a&nbsp;node&nbsp;has&nbsp;to&nbsp;anounce&nbsp;its&nbsp;presence<BR></SPAN>&nbsp;&nbsp;&nbsp;LifeTime&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;=&nbsp;5<SPAN class="keyword">*</SPAN>60<SPAN class="keyword">*</SPAN>1000&nbsp;<SPAN class="comment">%&nbsp;node&nbsp;default&nbsp;life&nbsp;time&nbsp;(5*60&nbsp;sec)<BR></SPAN>&nbsp;&nbsp;&nbsp;&nbsp;<BR>&nbsp;&nbsp;&nbsp;Args&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<SPAN class="comment">%&nbsp;record&nbsp;with&nbsp;the&nbsp;command&nbsp;arguments<BR></SPAN>&nbsp;&nbsp;&nbsp;OP2PS&nbsp;&nbsp;&nbsp;&nbsp;<SPAN class="comment">%&nbsp;an&nbsp;instance&nbsp;of&nbsp;class&nbsp;P2PS.p2pServices<BR></SPAN>&nbsp;&nbsp;&nbsp;MmbDict&nbsp;&nbsp;<SPAN class="comment">%&nbsp;a&nbsp;memership&nbsp;dictionary&nbsp;of&nbsp;node&nbsp;ids<BR></SPAN>&nbsp;&nbsp;&nbsp;LockDict&nbsp;<SPAN class="comment">%&nbsp;lock&nbsp;for&nbsp;MmbDict<BR></SPAN>&nbsp;&nbsp;&nbsp;&nbsp;<BR>&nbsp;&nbsp;&nbsp;<SPAN class="comment">%&nbsp;Build&nbsp;a&nbsp;node&nbsp;with&nbsp;node&nbsp;id&nbsp;NId&nbsp;on&nbsp;local&nbsp;port&nbsp;PN&nbsp;.<BR></SPAN>&nbsp;&nbsp;&nbsp;<SPAN class="keyword">proc</SPAN><SPAN class="variablename">&nbsp;</SPAN>{<SPAN class="functionname">MakeNode</SPAN>&nbsp;PN}<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<SPAN class="keyword">try</SPAN>&nbsp;&nbsp;<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;OP2PS={New&nbsp;P2PS<SPAN class="keyword">.</SPAN>p2pServices&nbsp;createNet(apConfig:apConfig(pn:PN))}<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{System<SPAN class="keyword">.</SPAN>showInfo&nbsp;<SPAN class="string">'local&nbsp;node&nbsp;created&nbsp;on&nbsp;port&nbsp;'</SPAN><SPAN class="keyword">#</SPAN>&nbsp;<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{OP2PS&nbsp;getAPConfig($)}<SPAN class="keyword">.</SPAN>pn}<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<SPAN class="keyword">catch</SPAN>&nbsp;p2ps(couldNotConfig&nbsp;pn:_)&nbsp;<SPAN class="keyword">then</SPAN>&nbsp;<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{System<SPAN class="keyword">.</SPAN>showInfo&nbsp;<SPAN class="string">'\n~~~&nbsp;exception:&nbsp;problem&nbsp;with&nbsp;the&nbsp;port:'</SPAN><SPAN class="keyword">#</SPAN>PN<SPAN class="keyword">#</SPAN><SPAN class="string">'\n'</SPAN>}<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{Application<SPAN class="keyword">.</SPAN>exit&nbsp;0}<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<SPAN class="keyword">end</SPAN>&nbsp;<BR>&nbsp;<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<SPAN class="keyword">thread</SPAN>&nbsp;{SendAlive}&nbsp;<SPAN class="keyword">end</SPAN>&nbsp;<BR>&nbsp;&nbsp;&nbsp;<SPAN class="keyword">end</SPAN>&nbsp;<BR>&nbsp;<BR>&nbsp;&nbsp;&nbsp;<SPAN class="comment">%&nbsp;Join&nbsp;the&nbsp;system&nbsp;via&nbsp;the&nbsp;node&nbsp;with&nbsp;IP&nbsp;and&nbsp;remote&nbsp;port#&nbsp;PN.<BR></SPAN>&nbsp;&nbsp;&nbsp;<SPAN class="comment">%&nbsp;LPN&nbsp;is&nbsp;the&nbsp;desired&nbsp;local&nbsp;port#<BR></SPAN>&nbsp;&nbsp;&nbsp;<SPAN class="keyword">proc</SPAN><SPAN class="variablename">&nbsp;</SPAN>{<SPAN class="functionname">JoinSys</SPAN>&nbsp;IP&nbsp;PN&nbsp;LPN}<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<SPAN class="keyword">try</SPAN>&nbsp;<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Tn&nbsp;=&nbsp;{P2PS<SPAN class="keyword">.</SPAN>address2ap&nbsp;IP&nbsp;PN}<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<SPAN class="keyword">in</SPAN>&nbsp;<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;OP2PS={New&nbsp;P2PS<SPAN class="keyword">.</SPAN>p2pServices<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;joinNet(remoteAP:Tn&nbsp;apConfig:&nbsp;apConfig(pn:LPN))}<BR>&nbsp;<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{System<SPAN class="keyword">.</SPAN>showInfo&nbsp;<SPAN class="string">'local&nbsp;node&nbsp;created&nbsp;on&nbsp;port&nbsp;'</SPAN><SPAN class="keyword">#</SPAN>&nbsp;<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{OP2PS&nbsp;getAPConfig($)}<SPAN class="keyword">.</SPAN>pn}<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{System<SPAN class="keyword">.</SPAN>showInfo&nbsp;<SPAN class="string">'my&nbsp;node&nbsp;Id&nbsp;is:&nbsp;'</SPAN><SPAN class="keyword">#</SPAN>{OP2PS&nbsp;getNodeConfig($)}<SPAN class="keyword">.</SPAN>nodeId}<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{OP2PS&nbsp;broadcast(msg:newnode)}<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<SPAN class="keyword">thread</SPAN>&nbsp;{SendAlive}&nbsp;<SPAN class="keyword">end</SPAN>&nbsp;<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<SPAN class="keyword">catch</SPAN>&nbsp;_&nbsp;<SPAN class="keyword">then</SPAN>&nbsp;<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{System<SPAN class="keyword">.</SPAN>showInfo&nbsp;<SPAN class="string">'\n~~~&nbsp;error:&nbsp;there&nbsp;was&nbsp;an&nbsp;error&nbsp;when&nbsp;joining&nbsp;the&nbsp;system\n'</SPAN>}<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{Application<SPAN class="keyword">.</SPAN>exit&nbsp;0}<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<SPAN class="keyword">end</SPAN>&nbsp;<BR>&nbsp;&nbsp;&nbsp;<SPAN class="keyword">end</SPAN>&nbsp;<BR>&nbsp;<BR>&nbsp;&nbsp;&nbsp;<SPAN class="comment">%&nbsp;Broadcast&nbsp;amAlive&nbsp;msg&nbsp;forever.<BR></SPAN>&nbsp;&nbsp;&nbsp;<SPAN class="keyword">proc</SPAN><SPAN class="variablename">&nbsp;</SPAN>{<SPAN class="functionname">SendAlive</SPAN>}<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{Delay&nbsp;RefreshTime}<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<SPAN class="keyword">try</SPAN>&nbsp;<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{OP2PS&nbsp;broadcast(msg:alive)}<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<SPAN class="keyword">catch</SPAN>&nbsp;_&nbsp;<SPAN class="keyword">then</SPAN>&nbsp;<SPAN class="keyword">skip</SPAN>&nbsp;<SPAN class="keyword">end</SPAN>&nbsp;<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{SendAlive}<BR>&nbsp;&nbsp;&nbsp;<SPAN class="keyword">end</SPAN>&nbsp;<BR>&nbsp;<BR>&nbsp;&nbsp;&nbsp;<SPAN class="comment">%&nbsp;Process&nbsp;the&nbsp;input&nbsp;message&nbsp;stream.<BR></SPAN>&nbsp;&nbsp;&nbsp;<SPAN class="keyword">proc</SPAN><SPAN class="variablename">&nbsp;</SPAN>{<SPAN class="functionname">ProcMsgStrm</SPAN>&nbsp;MS}<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<SPAN class="keyword">for</SPAN>&nbsp;E&nbsp;<SPAN class="keyword">in</SPAN>&nbsp;MS&nbsp;<SPAN class="keyword">do</SPAN>&nbsp;<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<SPAN class="keyword">case</SPAN>&nbsp;E&nbsp;<SPAN class="keyword">of</SPAN>&nbsp;rcvMsg(src:NId&nbsp;msg:M&nbsp;dst:_)&nbsp;<SPAN class="keyword">then</SPAN>&nbsp;<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<SPAN class="keyword">case</SPAN>&nbsp;M&nbsp;<SPAN class="keyword">of</SPAN>&nbsp;newnode&nbsp;<SPAN class="keyword">then</SPAN>&nbsp;<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{AddToMmbDict&nbsp;NId}<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<SPAN class="keyword">[]</SPAN>&nbsp;alive&nbsp;<SPAN class="keyword">then</SPAN>&nbsp;<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{AddToMmbDict&nbsp;NId}&nbsp;&nbsp;&nbsp;<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<SPAN class="keyword">[]</SPAN>&nbsp;leave&nbsp;<SPAN class="keyword">then</SPAN>&nbsp;<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{RemFromMmbDict&nbsp;NId&nbsp;<SPAN class="keyword">unit</SPAN>}&nbsp;&nbsp;&nbsp;&nbsp;<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<SPAN class="keyword">else</SPAN>&nbsp;<SPAN class="keyword">skip</SPAN>&nbsp;<SPAN class="keyword">end</SPAN>&nbsp;<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<SPAN class="keyword">end</SPAN>&nbsp;<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<SPAN class="keyword">end</SPAN>&nbsp;<BR>&nbsp;&nbsp;&nbsp;<SPAN class="keyword">end</SPAN>&nbsp;<BR>&nbsp;<BR>&nbsp;&nbsp;&nbsp;<SPAN class="comment">%&nbsp;Add&nbsp;node&nbsp;Id&nbsp;NId&nbsp;to&nbsp;MmbDict.<BR></SPAN>&nbsp;&nbsp;&nbsp;<SPAN class="keyword">proc</SPAN><SPAN class="variablename">&nbsp;</SPAN>{<SPAN class="functionname">AddToMmbDict</SPAN>&nbsp;NId}<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Vrs<BR>&nbsp;&nbsp;&nbsp;<SPAN class="keyword">in</SPAN>&nbsp;<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<SPAN class="keyword">lock</SPAN>&nbsp;LockDict&nbsp;<SPAN class="keyword">then</SPAN>&nbsp;<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<SPAN class="keyword">if</SPAN>&nbsp;{Dictionary<SPAN class="keyword">.</SPAN>condGet&nbsp;MmbDict&nbsp;NId&nbsp;nil}&nbsp;<SPAN class="keyword">\=</SPAN>&nbsp;nil&nbsp;<SPAN class="keyword">then</SPAN>&nbsp;<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Vrs&nbsp;=&nbsp;{Dictionary<SPAN class="keyword">.</SPAN>get&nbsp;MmbDict&nbsp;NId}<SPAN class="keyword">+</SPAN>1<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{Dictionary<SPAN class="keyword">.</SPAN>put&nbsp;MmbDict&nbsp;NId&nbsp;Vrs}<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<SPAN class="keyword">else</SPAN>&nbsp;<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Vrs&nbsp;=&nbsp;0<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{Dictionary<SPAN class="keyword">.</SPAN>put&nbsp;MmbDict&nbsp;NId&nbsp;Vrs}<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{System<SPAN class="keyword">.</SPAN>showInfo&nbsp;<SPAN class="string">'node:&nbsp;'</SPAN><SPAN class="keyword">#</SPAN>NId<SPAN class="keyword">#</SPAN><SPAN class="string">'&nbsp;added'</SPAN>}<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{System<SPAN class="keyword">.</SPAN>show&nbsp;membership<SPAN class="keyword">#</SPAN>{Dictionary<SPAN class="keyword">.</SPAN>keys&nbsp;MmbDict}}<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<SPAN class="keyword">end</SPAN>&nbsp;<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<SPAN class="keyword">end</SPAN>&nbsp;<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<SPAN class="keyword">thread</SPAN>&nbsp;<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<SPAN class="comment">%&nbsp;after&nbsp;RefreshTime&nbsp;plus&nbsp;some&nbsp;delay&nbsp;remove&nbsp;Nid<BR></SPAN>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{Delay&nbsp;RefreshTime<SPAN class="keyword">+</SPAN>5000}&nbsp;&nbsp;<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{RemFromMmbDict&nbsp;NId&nbsp;Vrs}<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<SPAN class="keyword">end</SPAN>&nbsp;<BR>&nbsp;&nbsp;&nbsp;<SPAN class="keyword">end</SPAN>&nbsp;<BR>&nbsp;<BR>&nbsp;&nbsp;&nbsp;<SPAN class="comment">%&nbsp;Remove&nbsp;node&nbsp;Id&nbsp;NId&nbsp;from&nbsp;MmbDict,&nbsp;if&nbsp;inside&nbsp;and&nbsp;the&nbsp;right&nbsp;version&nbsp;is&nbsp;used.<BR></SPAN>&nbsp;&nbsp;&nbsp;<SPAN class="keyword">proc</SPAN><SPAN class="variablename">&nbsp;</SPAN>{<SPAN class="functionname">RemFromMmbDict</SPAN>&nbsp;NId&nbsp;Vrs}<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;E<BR>&nbsp;&nbsp;&nbsp;<SPAN class="keyword">in</SPAN>&nbsp;<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<SPAN class="keyword">lock</SPAN>&nbsp;LockDict&nbsp;<SPAN class="keyword">then</SPAN>&nbsp;<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;E&nbsp;=&nbsp;{Dictionary<SPAN class="keyword">.</SPAN>condGet&nbsp;MmbDict&nbsp;NId&nbsp;nil}<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<SPAN class="keyword">if</SPAN>&nbsp;E&nbsp;<SPAN class="keyword">==</SPAN>&nbsp;Vrs&nbsp;<SPAN class="keyword">then</SPAN>&nbsp;<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{Dictionary<SPAN class="keyword">.</SPAN>remove&nbsp;MmbDict&nbsp;NId}<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{System<SPAN class="keyword">.</SPAN>showInfo&nbsp;<SPAN class="string">'node:&nbsp;'</SPAN><SPAN class="keyword">#</SPAN>NId<SPAN class="keyword">#</SPAN><SPAN class="string">'&nbsp;dropped'</SPAN>}<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{System<SPAN class="keyword">.</SPAN>show&nbsp;membership<SPAN class="keyword">#</SPAN>{Dictionary<SPAN class="keyword">.</SPAN>keys&nbsp;MmbDict}}<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<SPAN class="keyword">elseif</SPAN>&nbsp;Vrs&nbsp;<SPAN class="keyword">==</SPAN>&nbsp;<SPAN class="keyword">unit</SPAN>&nbsp;<SPAN class="keyword">then</SPAN>&nbsp;<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{Dictionary<SPAN class="keyword">.</SPAN>remove&nbsp;MmbDict&nbsp;NId}<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{System<SPAN class="keyword">.</SPAN>showInfo&nbsp;<SPAN class="string">'node:&nbsp;'</SPAN><SPAN class="keyword">#</SPAN>NId<SPAN class="keyword">#</SPAN><SPAN class="string">'&nbsp;left'</SPAN>}<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{System<SPAN class="keyword">.</SPAN>show&nbsp;membership<SPAN class="keyword">#</SPAN>{Dictionary<SPAN class="keyword">.</SPAN>keys&nbsp;MmbDict}}<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<SPAN class="keyword">end</SPAN>&nbsp;<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<SPAN class="keyword">end</SPAN>&nbsp;<BR>&nbsp;&nbsp;&nbsp;<SPAN class="keyword">end</SPAN>&nbsp;<BR>&nbsp;<BR><SPAN class="keyword">in</SPAN>&nbsp;<BR>&nbsp;&nbsp;&nbsp;MmbDict&nbsp;=&nbsp;{NewDictionary}<BR>&nbsp;&nbsp;&nbsp;LockDict&nbsp;=&nbsp;{NewLock}<BR>&nbsp;&nbsp;&nbsp;&nbsp;<BR>&nbsp;&nbsp;&nbsp;<SPAN class="comment">%&nbsp;specify&nbsp;the&nbsp;application&nbsp;input&nbsp;arguments<BR></SPAN>&nbsp;&nbsp;&nbsp;Args&nbsp;=&nbsp;{Application<SPAN class="keyword">.</SPAN>getCmdArgs<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;record(host(single&nbsp;type:atom&nbsp;default:<SPAN class="keyword">unit</SPAN>)&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<SPAN class="comment">%&nbsp;host&nbsp;name<BR></SPAN>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;lport(single&nbsp;type:int&nbsp;default:_)&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<SPAN class="comment">%&nbsp;local&nbsp;port<BR></SPAN>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;rport(single&nbsp;type:int&nbsp;default:<SPAN class="keyword">unit</SPAN>)&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<SPAN class="comment">%&nbsp;remote&nbsp;port<BR></SPAN>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;lifetime(single&nbsp;type:int&nbsp;default:LifeTime))}&nbsp;<SPAN class="comment">%&nbsp;node's&nbsp;life&nbsp;time<BR></SPAN>&nbsp;<BR>&nbsp;&nbsp;&nbsp;<SPAN class="keyword">if</SPAN>&nbsp;Args<SPAN class="keyword">.</SPAN>host&nbsp;<SPAN class="keyword">\=</SPAN>&nbsp;<SPAN class="keyword">unit</SPAN>&nbsp;<SPAN class="keyword">then</SPAN>&nbsp;<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<SPAN class="keyword">if</SPAN>&nbsp;Args<SPAN class="keyword">.</SPAN>rport&nbsp;<SPAN class="keyword">\=</SPAN>&nbsp;<SPAN class="keyword">unit</SPAN>&nbsp;<SPAN class="keyword">then</SPAN>&nbsp;<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{JoinSys&nbsp;Args<SPAN class="keyword">.</SPAN>host&nbsp;Args<SPAN class="keyword">.</SPAN>rport&nbsp;Args<SPAN class="keyword">.</SPAN>lport}<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<SPAN class="keyword">thread</SPAN>&nbsp;{ProcMsgStrm&nbsp;{OP2PS&nbsp;getMsgStrm($)}}&nbsp;<SPAN class="keyword">end</SPAN>&nbsp;<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<SPAN class="keyword">else</SPAN>&nbsp;<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{System<SPAN class="keyword">.</SPAN>showInfo&nbsp;<SPAN class="string">'\n~~~&nbsp;error:&nbsp;provide&nbsp;the&nbsp;remote&nbsp;port:&nbsp;e.g.,&nbsp;--rport&nbsp;3002\n'</SPAN>}<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{Application<SPAN class="keyword">.</SPAN>exit&nbsp;0}<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<SPAN class="keyword">end</SPAN>&nbsp;<BR>&nbsp;&nbsp;&nbsp;<SPAN class="keyword">else</SPAN>&nbsp;<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{MakeNode&nbsp;Args<SPAN class="keyword">.</SPAN>lport}<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<SPAN class="keyword">thread</SPAN>&nbsp;{ProcMsgStrm&nbsp;{OP2PS&nbsp;getMsgStrm($)}}&nbsp;<SPAN class="keyword">end</SPAN>&nbsp;<BR>&nbsp;&nbsp;&nbsp;<SPAN class="keyword">end</SPAN>&nbsp;<BR>&nbsp;<BR>&nbsp;&nbsp;&nbsp;<SPAN class="keyword">thread</SPAN>&nbsp;<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<SPAN class="comment">%&nbsp;after&nbsp;a&nbsp;live&nbsp;time&nbsp;leave&nbsp;the&nbsp;sys&nbsp;and&nbsp;close&nbsp;the&nbsp;application<BR></SPAN>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{Delay&nbsp;Args<SPAN class="keyword">.</SPAN>lifetime<SPAN class="keyword">*</SPAN>1000}&nbsp;&nbsp;<BR>&nbsp;<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<SPAN class="keyword">try</SPAN>&nbsp;<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{OP2PS&nbsp;broadcast(msg:leave)}<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<SPAN class="keyword">catch</SPAN>&nbsp;_&nbsp;<SPAN class="keyword">then</SPAN>&nbsp;<SPAN class="keyword">skip</SPAN>&nbsp;<SPAN class="keyword">end</SPAN>&nbsp;<BR>&nbsp;<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{Delay&nbsp;1000}&nbsp;&nbsp;<SPAN class="comment">%&nbsp;wait&nbsp;some&nbsp;time&nbsp;until&nbsp;msg&nbsp;leave&nbsp;is&nbsp;sent<BR></SPAN>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{OP2PS&nbsp;leaveNet}<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{Application<SPAN class="keyword">.</SPAN>exit&nbsp;0}&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<BR>&nbsp;&nbsp;&nbsp;<SPAN class="keyword">end</SPAN>&nbsp;<BR><SPAN class="keyword">end</SPAN>&nbsp;<BR></PRE></BLOCKQUOTE><P></P><H3><A name="label4">4.3.1 Application parameters</A></H3><P></P><DL><DT><CODE><SPAN class="keyword">--</SPAN>lport</CODE></DT><DD><P>The local port on which to open the access point at this node. This param is optional. </P></DD><DT><CODE><SPAN class="keyword">--</SPAN>host</CODE></DT><DD><P>The host of the node through which the join will be done. If not provided, the node will not do join to any network, i.e., it is the first node in the network. </P></DD><DT><CODE><SPAN class="keyword">--</SPAN>rport</CODE></DT><DD><P>The port number of the node through which the join will be done. If <CODE><SPAN class="keyword">--</SPAN>host</CODE> is provided then <CODE><SPAN class="keyword">--</SPAN>rport</CODE> must be provided. </P></DD><DT><CODE><SPAN class="keyword">--</SPAN>lifetime</CODE></DT><DD><P>The life time of the application (sec). Default is 5 minutes. This param is optional.</P></DD></DL><P> </P><H3><A name="label5">4.3.2 Running the application</A></H3><P>The first created node should not to do any join. It is the node who creates the P2P network. The port# of the access point is displayed. So just type:</P><P>$ .<CODE><SPAN class="keyword">/</SPAN>clbpeer</CODE> </P><P>The forthcoming nodes must do join in order to be part of a network, thus they must provide the <CODE><SPAN class="keyword">--</SPAN>host</CODE> and <CODE><SPAN class="keyword">--</SPAN>rport</CODE> params. So you can type something like : </P><P>$ <CODE><SPAN class="keyword">./</SPAN>clbpeer</CODE> <CODE><SPAN class="keyword">--</SPAN>host</CODE>=localhost <CODE><SPAN class="keyword">--</SPAN>rport</CODE>=34200 </P></DIV><TABLE align="center" border="0" cellpadding="6" cellspacing="6" class="nav"><TR bgcolor="#DDDDDD"><TD><A href="node3.html#chapter.eventsmessages">&lt;&lt; Prev</A></TD><TD><A href="index.html">- Up -</A></TD><TD><A href="node5.html#chapter.install">Next &gt;&gt;</A></TD></TR></TABLE><HR><ADDRESS>Bruno Carton and Valentin Mesaros<BR></ADDRESS></BODY></HTML>
