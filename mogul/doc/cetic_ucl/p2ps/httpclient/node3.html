<!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.0 Transitional//EN">
<HTML><HEAD><TITLE>3 Tutorial Examples</TITLE><LINK href="ozdoc.css" rel="stylesheet" type="text/css"></HEAD><BODY><TABLE align="center" border="0" cellpadding="6" cellspacing="6" class="nav"><TR bgcolor="#DDDDDD"><TD><A href="node2.html#chapter.httpclient">&lt;&lt; Prev</A></TD><TD><A href="http://www.info.ucl.ac.be/%7Evalentin/httpclient/index.html">- Up -</A></TD><TD><A href="node4.html#chapter.applications">Next &gt;&gt;</A></TD></TR></TABLE><DIV id="chapter.examples"><H1><A name="chapter.examples">3 Tutorial Examples</A></H1><P>The examples given in this chapter are functors. As we've stated before, in <A href="node2.html#chapter.httpclient">Chapter&nbsp;2</A>, the main programming interface of the <CODE>HttpClient</CODE> package is provided by the specialised classes found within <CODE>HttpClient</CODE> module, namely <CODE>CgiGET</CODE>, <CODE>CgiPOST</CODE>, <CODE>CgiISINDEX</CODE>, <CODE>UrlGET</CODE> and <CODE>UrlHEAD</CODE>. In order to use them, we have to <CODE><SPAN class="keyword">import</SPAN></CODE> <CODE><SPAN class="string">'x-ozlib://mesaros/net/HTTPClient.ozf'</SPAN></CODE> functor in our examples, since it includes all the functors of this package in a prelinked fashion. </P><H2><A name="label6">3.1 Download a document</A></H2><P>This short example shows how a document located at <CODE>Url</CODE> can be downloaded using <CODE>HttpClient<SPAN class="keyword">.</SPAN>getUrl</CODE> class. The first step is the initialisation of the class, using its <CODE>init</CODE> method. Note that the provided input parameters are unbound. In this case they will be given default values. The second step is calling the <CODE>getService</CODE> method, thus invoking the service. We don't want to reach the output parameters so we don't bound them.</P><P>The content of the downloaded document will be put into the file having the given <CODE>Url</CODE> based name, <CODE><SPAN class="string">&quot;index.html&quot;</SPAN></CODE> in our case. </P><P class="margin"><A href="http://www.info.ucl.ac.be/%7Evalentin/httpclient/exmpl1.oz">Source File</A></P><P> </P><BLOCKQUOTE><PRE><SPAN class="comment">%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%<BR>%%&nbsp;Simple&nbsp;use&nbsp;of&nbsp;HttpClient.urlGET&nbsp;class&nbsp;%%<BR>%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%<BR></SPAN><SPAN class="keyword">functor</SPAN>&nbsp;<BR><SPAN class="keyword">import</SPAN>&nbsp;&nbsp;<BR>&nbsp;&nbsp;&nbsp;System<BR>&nbsp;&nbsp;&nbsp;Application<BR>&nbsp;&nbsp;&nbsp;HTTPClient&nbsp;<SPAN class="keyword">at</SPAN>&nbsp;<SPAN class="string">'x-ozlib://mesaros/net/HTTPClient.ozf'</SPAN>&nbsp;&nbsp;<BR><SPAN class="keyword">define</SPAN>&nbsp;<BR>&nbsp;&nbsp;&nbsp;<SPAN class="keyword">proc</SPAN><SPAN class="variablename">&nbsp;</SPAN>{<SPAN class="functionname">GetDoc</SPAN>&nbsp;Url}<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;HCObj<BR>&nbsp;&nbsp;&nbsp;<SPAN class="keyword">in</SPAN>&nbsp;&nbsp;&nbsp;&nbsp;<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;HCObj={New&nbsp;HTTPClient<SPAN class="keyword">.</SPAN>urlGET&nbsp;init(_&nbsp;_)}<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<SPAN class="keyword">try</SPAN>&nbsp;<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{HCObj&nbsp;getService(Url&nbsp;_&nbsp;_)}<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<SPAN class="keyword">catch</SPAN>&nbsp;E&nbsp;<SPAN class="keyword">then</SPAN>&nbsp;<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{System<SPAN class="keyword">.</SPAN>show&nbsp;E}<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<SPAN class="keyword">end</SPAN>&nbsp;<BR>&nbsp;&nbsp;&nbsp;<SPAN class="keyword">end</SPAN>&nbsp;<BR><SPAN class="keyword">in</SPAN>&nbsp;<BR>&nbsp;&nbsp;&nbsp;{GetDoc&nbsp;<SPAN class="string">&quot;http://www.info.ucl.ac.be/index.html&quot;</SPAN>}<BR>&nbsp;&nbsp;&nbsp;{Application<SPAN class="keyword">.</SPAN>exit&nbsp;0}<BR><SPAN class="keyword">end</SPAN>&nbsp;<BR></PRE></BLOCKQUOTE><P></P><P><CODE>HttpClient<SPAN class="keyword">.</SPAN>getHEAD</CODE> class can be used in the same manner. In this case the content of the document will not be fetched, but its HTTP response headers will be returned. </P><H2><A name="label7">3.2 Build CGI queries</A></H2><P>This example shows how <CODE>HttpClient<SPAN class="keyword">.</SPAN>cgiGET</CODE> class can be used to build CGI queries (e.g. to Yahoo web search engine). The parameters of the query is given by <CODE>CgiParams</CODE> which is a list of <CODE><SPAN class="string">&quot;name&quot;</SPAN><SPAN class="keyword">#</SPAN><SPAN class="string">&quot;value&quot;</SPAN></CODE> strings pairs. In our very case, we want to retrieve a document containing a list of keyword <CODE><SPAN class="string">&quot;travel&quot;</SPAN></CODE> related resources. Since the name of the file the retrieved document should be put is provided, it will be used. <CODE>toFile</CODE> feature is <CODE><SPAN class="keyword">true</SPAN></CODE> by default.</P><P>The size of bytes of the requested document <CODE>OutPrms<SPAN class="keyword">.</SPAN>sizeRead</CODE> read from the socket is displayed. Since it is a string, the name of the peer <CODE>HttpPrms<SPAN class="keyword">.</SPAN>server</CODE> is displayed as an atom, so we can easily see it. Note the use of <CODE>HttpReqPrms</CODE> record in order to specify the languages we accept from the peer. </P><P class="margin"><A href="http://www.info.ucl.ac.be/%7Evalentin/httpclient/exmpl2.oz">Source File</A></P><P> </P><BLOCKQUOTE><PRE><SPAN class="comment">%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%<BR>%%&nbsp;Simple&nbsp;use&nbsp;of&nbsp;HttpClient.cgiGET&nbsp;class&nbsp;%%<BR>%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%<BR></SPAN><SPAN class="keyword">functor</SPAN>&nbsp;<BR><SPAN class="keyword">import</SPAN>&nbsp;&nbsp;<BR>&nbsp;&nbsp;&nbsp;System<BR>&nbsp;&nbsp;&nbsp;Application<BR>&nbsp;&nbsp;&nbsp;HTTPClient&nbsp;<SPAN class="keyword">at</SPAN>&nbsp;<SPAN class="string">'x-ozlib://mesaros/net/HTTPClient.ozf'</SPAN>&nbsp;&nbsp;<BR><SPAN class="keyword">define</SPAN>&nbsp;<BR>&nbsp;&nbsp;&nbsp;Url&nbsp;=&nbsp;<SPAN class="string">&quot;search.yahoo.com/bin/search&quot;</SPAN>&nbsp;<BR>&nbsp;&nbsp;&nbsp;CgiParams&nbsp;=&nbsp;[<SPAN class="string">&quot;p&quot;</SPAN><SPAN class="keyword">#</SPAN><SPAN class="string">&quot;travel&quot;</SPAN>]<BR>&nbsp;&nbsp;&nbsp;OutPrms<BR>&nbsp;&nbsp;&nbsp;HRepPrms<BR>&nbsp;&nbsp;&nbsp;HCObj<BR><SPAN class="keyword">in</SPAN>&nbsp;&nbsp;&nbsp;&nbsp;<BR>&nbsp;&nbsp;&nbsp;HCObj={New&nbsp;HTTPClient<SPAN class="keyword">.</SPAN>cgiGET&nbsp;init(inPrms(file:<SPAN class="string">&quot;ysearch&quot;</SPAN>)<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;httpReqPrms(accept_language:<SPAN class="string">&quot;fr-BE,&nbsp;en&quot;</SPAN>))}<BR>&nbsp;&nbsp;&nbsp;<SPAN class="keyword">try</SPAN>&nbsp;<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{HCObj&nbsp;getService(Url&nbsp;CgiParams&nbsp;OutPrms&nbsp;HRepPrms)}<BR>&nbsp;&nbsp;&nbsp;<SPAN class="keyword">catch</SPAN>&nbsp;E&nbsp;<SPAN class="keyword">then</SPAN>&nbsp;<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{System<SPAN class="keyword">.</SPAN>show&nbsp;E}<BR>&nbsp;&nbsp;&nbsp;<SPAN class="keyword">end</SPAN>&nbsp;<BR>&nbsp;&nbsp;&nbsp;{System<SPAN class="keyword">.</SPAN>show&nbsp;sizeread<SPAN class="keyword">#</SPAN>OutPrms<SPAN class="keyword">.</SPAN>sizeRead}<BR>&nbsp;&nbsp;&nbsp;{System<SPAN class="keyword">.</SPAN>show&nbsp;http_server<SPAN class="keyword">#</SPAN>{VirtualString<SPAN class="keyword">.</SPAN>toAtom&nbsp;HRepPrms<SPAN class="keyword">.</SPAN>server}}<BR>&nbsp;&nbsp;&nbsp;{Application<SPAN class="keyword">.</SPAN>exit&nbsp;0}<BR><SPAN class="keyword">end</SPAN>&nbsp;<BR></PRE></BLOCKQUOTE><P></P><P></P><P><CODE>HttpClient<SPAN class="keyword">.</SPAN>cgiPOST</CODE> and <CODE>HttpClient<SPAN class="keyword">.</SPAN>cgiISINDEX</CODE> classes can be used in the same manner. In the latter case <CODE>CgiParams</CODE> has to be a string. </P><H2><A name="label8">3.3 Use of some package functionality</A></H2><P>Among the examples presented in this chapter, this one involves the use of the grater number of service's methods, namely <CODE>bytesRead</CODE>, <CODE>stopTemp</CODE> and <CODE>startTemp</CODE>. Thus, in order to have access to these methods, while the document is being fetched, we will separate the processes by using the threads.</P><P>By calling <CODE>GetRate</CODE> procedure, it will display the transmission rate, the time it was computed and the instantaneous number of bytes read, by reading the <CODE>rateStrm</CODE> stream and calling <CODE>bytesRead</CODE> method, respectively. The transmission rates are computed as an average over 350 ms time interval (as indicated by <CODE>tInterval</CODE>). After a period of 850 ms the transmission will be temporarily stopped and continued after other 3000 ms period. </P><P class="margin"><A href="http://www.info.ucl.ac.be/%7Evalentin/httpclient/exmpl3.oz">Source File</A></P><P> </P><BLOCKQUOTE><PRE><SPAN class="comment">%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%<BR>%%&nbsp;Simple&nbsp;use&nbsp;of&nbsp;the&nbsp;bytesRead,&nbsp;stopTemp&nbsp;and&nbsp;&nbsp;&nbsp;&nbsp;%%<BR>%%&nbsp;startTemp&nbsp;methods&nbsp;of&nbsp;HttpClient.urlGET&nbsp;class&nbsp;%%<BR>%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%<BR></SPAN><SPAN class="keyword">functor</SPAN>&nbsp;<BR><SPAN class="keyword">import</SPAN>&nbsp;&nbsp;<BR>&nbsp;&nbsp;&nbsp;System<BR>&nbsp;&nbsp;&nbsp;Application<BR>&nbsp;&nbsp;&nbsp;HTTPClient&nbsp;<SPAN class="keyword">at</SPAN>&nbsp;<SPAN class="string">'x-ozlib://mesaros/net/HTTPClient.ozf'</SPAN>&nbsp;&nbsp;<BR><SPAN class="keyword">define</SPAN>&nbsp;<BR>&nbsp;&nbsp;&nbsp;Url&nbsp;=&nbsp;<SPAN class="string">&quot;http://rfc.fh-koeln.de/rfc/html/rfc0959.html&quot;</SPAN>&nbsp;<BR>&nbsp;&nbsp;&nbsp;OutPrms<BR>&nbsp;&nbsp;&nbsp;<SPAN class="keyword">proc</SPAN><SPAN class="variablename">&nbsp;</SPAN>{<SPAN class="functionname">UseIt</SPAN>}<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;HCObj<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ServiceEnd<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<SPAN class="keyword">proc</SPAN><SPAN class="variablename">&nbsp;</SPAN>{<SPAN class="functionname">GetRate</SPAN>&nbsp;Stream}<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<SPAN class="keyword">case</SPAN>&nbsp;Stream&nbsp;<SPAN class="keyword">of</SPAN>&nbsp;nil&nbsp;<SPAN class="keyword">then</SPAN>&nbsp;<SPAN class="keyword">skip</SPAN>&nbsp;<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<SPAN class="keyword">[]</SPAN>&nbsp;X<SPAN class="keyword">|</SPAN>Xr&nbsp;<SPAN class="keyword">then</SPAN>&nbsp;<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<SPAN class="keyword">if</SPAN>&nbsp;X<SPAN class="keyword">\=</SPAN>nil&nbsp;<SPAN class="keyword">then</SPAN>&nbsp;<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{System<SPAN class="keyword">.</SPAN>show&nbsp;X<SPAN class="keyword">#</SPAN>{HCObj&nbsp;bytesRead($)}}<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{GetRate&nbsp;Xr}&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<SPAN class="keyword">end</SPAN>&nbsp;<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<SPAN class="keyword">end</SPAN>&nbsp;<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<SPAN class="keyword">end</SPAN>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<BR>&nbsp;&nbsp;&nbsp;<SPAN class="keyword">in</SPAN>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;HCObj={New&nbsp;HTTPClient<SPAN class="keyword">.</SPAN>urlGET&nbsp;init(inPrms(toFile:<SPAN class="keyword">false</SPAN>&nbsp;tInterval:350)&nbsp;_)}<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<SPAN class="keyword">thread</SPAN>&nbsp;<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<SPAN class="keyword">try</SPAN>&nbsp;<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{HCObj&nbsp;getService(Url&nbsp;OutPrms&nbsp;_)}<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<SPAN class="keyword">catch</SPAN>&nbsp;E&nbsp;<SPAN class="keyword">then</SPAN>&nbsp;<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{System<SPAN class="keyword">.</SPAN>show&nbsp;E}<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<SPAN class="keyword">finally</SPAN>&nbsp;&nbsp;<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ServiceEnd=<SPAN class="keyword">unit</SPAN>&nbsp;<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<SPAN class="keyword">end</SPAN>&nbsp;<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<SPAN class="keyword">end</SPAN>&nbsp;<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<SPAN class="keyword">thread</SPAN>&nbsp;{GetRate&nbsp;OutPrms<SPAN class="keyword">.</SPAN>rateStrm}&nbsp;<SPAN class="keyword">end</SPAN>&nbsp;<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{Delay&nbsp;850}<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{HCObj&nbsp;stopTemp}<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{Delay&nbsp;3000}<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{HCObj&nbsp;startTemp}<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{Wait&nbsp;ServiceEnd}<BR>&nbsp;&nbsp;&nbsp;<SPAN class="keyword">end</SPAN>&nbsp;<BR><SPAN class="keyword">in</SPAN>&nbsp;<BR>&nbsp;&nbsp;&nbsp;{UseIt}<BR>&nbsp;&nbsp;&nbsp;{Application<SPAN class="keyword">.</SPAN>exit&nbsp;0}<BR><SPAN class="keyword">end</SPAN>&nbsp;<BR></PRE></BLOCKQUOTE><P></P><H2><A name="label9">3.4 Rate based document download</A></H2><P>In order to emphasise the advantages of having access to the transfer rate of the document being downloaded, we've conceived a small example. Given a list <CODE>Urls</CODE> of different Url addresses of the same document, a threshold rate <CODE>RateTh</CODE> and a time period <CODE>TimePeriod</CODE>, it will try to fetch the first document in the list whose transfer rate is grater or equal with <CODE>RateTh</CODE>. <CODE>TimePeriod</CODE> represents the time period the rate transfer is allowed to be below <CODE>RateTh</CODE>. If the rate transfer rests below <CODE>RateTh</CODE> a certain period grater than <CODE>TimePeriod</CODE>, the current download is terminated and the next address in the <CODE>Urls</CODE> list will be processed, by using <CODE>GetDoc</CODE>. </P><P class="margin"><A href="http://www.info.ucl.ac.be/%7Evalentin/httpclient/exmpl4.oz">Source File</A></P><P> </P><DL><DT><SPAN class="chunktitle"><SPAN class="chunkborder">&lt;</SPAN><A name="label10">Rate based document download</A><SPAN class="chunkborder">&gt;=</SPAN></SPAN></DT><DD class="code"><CODE><SPAN class="keyword">functor</SPAN>&nbsp;&nbsp;&nbsp;<BR><SPAN class="keyword">import</SPAN>&nbsp;<BR>&nbsp;&nbsp;&nbsp;System<BR>&nbsp;&nbsp;&nbsp;Application<BR>&nbsp;&nbsp;&nbsp;HTTPClient&nbsp;<SPAN class="keyword">at</SPAN>&nbsp;<SPAN class="string">'x-ozlib://mesaros/net/HTTPClient.ozf'</SPAN>&nbsp;&nbsp;<BR><SPAN class="keyword">define</SPAN>&nbsp;<BR>&nbsp;&nbsp;&nbsp;</CODE><SPAN class="chunktitle"><SPAN class="chunkborder">&lt;</SPAN><A href="node3.html#label11">GetDoc: get a document considering the transfer rate</A><SPAN class="chunkborder">&gt;</SPAN></SPAN><CODE>&nbsp;<BR>&nbsp;&nbsp;&nbsp;Urls&nbsp;=&nbsp;[<SPAN class="string">&quot;http://www.ring.gr.jp/pub/doc/RFC/rfc2616.txt&quot;</SPAN>&nbsp;<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<SPAN class="string">&quot;http://sunsite.doc.ic.ac.uk/rfc/rfc2616.txt&quot;</SPAN>]<BR>&nbsp;&nbsp;&nbsp;TimePeriod&nbsp;=&nbsp;1000&nbsp;&nbsp;&nbsp;&nbsp;<SPAN class="comment">%%&nbsp;milliseconds<BR></SPAN>&nbsp;&nbsp;&nbsp;RateTh&nbsp;=&nbsp;25<SPAN class="keyword">.</SPAN>0&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<SPAN class="comment">%%&nbsp;KB/s<BR></SPAN><SPAN class="keyword">in</SPAN>&nbsp;<BR>&nbsp;&nbsp;&nbsp;{List<SPAN class="keyword">.</SPAN>dropWhile&nbsp;Urls&nbsp;GetDoc&nbsp;_}<BR>&nbsp;&nbsp;&nbsp;{Application<SPAN class="keyword">.</SPAN>exit&nbsp;0}<BR><SPAN class="keyword">end</SPAN></CODE></DD></DL><P> </P><P><CODE>GetDoc</CODE> is the function used for downloading a document considering its transfer rate. It contains two other procedures, namely <CODE>GetRate</CODE> and <CODE>WaitFor</CODE> and returns <CODE>Continue</CODE> as being <CODE><SPAN class="keyword">false</SPAN></CODE> if the current service has fulfilled the imposed conditions or <CODE><SPAN class="keyword">true</SPAN></CODE> otherwise. </P><DL><DT><SPAN class="chunktitle"><SPAN class="chunkborder">&lt;</SPAN><A name="label11">GetDoc: get a document considering the transfer rate</A><SPAN class="chunkborder">&gt;=</SPAN></SPAN></DT><DD class="code"><CODE><SPAN class="keyword">fun</SPAN><SPAN class="variablename">&nbsp;</SPAN>{<SPAN class="functionname">GetDoc</SPAN>&nbsp;Url}<BR>&nbsp;&nbsp;&nbsp;</CODE><SPAN class="chunktitle"><SPAN class="chunkborder">&lt;</SPAN><A href="node3.html#label13">GetRate: get and evaluate the transfer rate</A><SPAN class="chunkborder">&gt;</SPAN></SPAN><CODE>&nbsp;<BR>&nbsp;&nbsp;&nbsp;</CODE><SPAN class="chunktitle"><SPAN class="chunkborder">&lt;</SPAN><A href="node3.html#label14">WaitFor: wait a period before closing the service</A><SPAN class="chunkborder">&gt;</SPAN></SPAN><CODE>&nbsp;<BR>&nbsp;&nbsp;&nbsp;HCObj<BR>&nbsp;&nbsp;&nbsp;OutPrms<BR>&nbsp;&nbsp;&nbsp;TimeCounter&nbsp;=&nbsp;{Cell<SPAN class="keyword">.</SPAN>new&nbsp;0}<BR>&nbsp;&nbsp;&nbsp;Continue&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<BR><SPAN class="keyword">in</SPAN>&nbsp;<BR>&nbsp;&nbsp;&nbsp;{System<SPAN class="keyword">.</SPAN>show&nbsp;trying<SPAN class="keyword">#</SPAN>{VirtualString<SPAN class="keyword">.</SPAN>toAtom&nbsp;Url}}<BR>&nbsp;&nbsp;&nbsp;</CODE><SPAN class="chunktitle"><SPAN class="chunkborder">&lt;</SPAN><A href="node3.html#label12">HttpService: call getURL service</A><SPAN class="chunkborder">&gt;</SPAN></SPAN><CODE>&nbsp;<BR>&nbsp;&nbsp;&nbsp;Continue<BR><SPAN class="keyword">end</SPAN></CODE></DD></DL><P> </P><P>A simple way to call an HttpClient service in parallel with a procedure, namely <CODE>GateRate</CODE>, which treats one of its output, namely <CODE>rateStrm</CODE>, is shown below. </P><DL><DT><SPAN class="chunktitle"><SPAN class="chunkborder">&lt;</SPAN><A name="label12">HttpService: call getURL service</A><SPAN class="chunkborder">&gt;=</SPAN></SPAN></DT><DD class="code"><CODE>HCObj={New&nbsp;HTTPClient<SPAN class="keyword">.</SPAN>urlGET&nbsp;init(_&nbsp;_)}<BR><SPAN class="keyword">thread</SPAN>&nbsp;{GetRate&nbsp;OutPrms<SPAN class="keyword">.</SPAN>rateStrm&nbsp;_&nbsp;_}&nbsp;<SPAN class="keyword">end</SPAN>&nbsp;<BR><SPAN class="keyword">try</SPAN>&nbsp;<BR>&nbsp;&nbsp;&nbsp;{HCObj&nbsp;getService(Url&nbsp;OutPrms&nbsp;_)}<BR><SPAN class="keyword">catch</SPAN>&nbsp;_&nbsp;<SPAN class="keyword">then</SPAN>&nbsp;<BR>&nbsp;&nbsp;&nbsp;Continue&nbsp;=&nbsp;<SPAN class="keyword">true</SPAN>&nbsp;<BR><SPAN class="keyword">end</SPAN></CODE></DD></DL><P> </P><P>The transfer rate evaluation is done by <CODE>GetRate</CODE> procedure. It compares the instantaneous rate <CODE>X<SPAN class="keyword">.</SPAN>1</CODE> with <CODE>RateTh</CODE>. There are two main situations, the first one: the instantaneous rate is grater or equal with <CODE>RateTh</CODE>, and the second one: the instantaneous rate is below <CODE>RateTh</CODE>. Since the rate occurrence over <CODE>rateStrm</CODE> is aleatoric, a time counter <CODE>TimeCounter</CODE> and <CODE>WaitFor</CODE> procedure are used. </P><DL><DT><SPAN class="chunktitle"><SPAN class="chunkborder">&lt;</SPAN><A name="label13">GetRate: get and evaluate the transfer rate</A><SPAN class="chunkborder">&gt;=</SPAN></SPAN></DT><DD class="code"><CODE><SPAN class="keyword">proc</SPAN><SPAN class="variablename">&nbsp;</SPAN>{<SPAN class="functionname">GetRate</SPAN>&nbsp;Stream&nbsp;PrevTime&nbsp;PLock}&nbsp;LLock&nbsp;<SPAN class="keyword">in</SPAN>&nbsp;<BR>&nbsp;&nbsp;&nbsp;<SPAN class="keyword">case</SPAN>&nbsp;Stream&nbsp;<SPAN class="keyword">of</SPAN>&nbsp;nil&nbsp;<SPAN class="keyword">then</SPAN>&nbsp;<BR>&nbsp;&nbsp;&nbsp;PLock=<SPAN class="keyword">unit</SPAN>&nbsp;<BR>&nbsp;&nbsp;&nbsp;Continue=<SPAN class="keyword">true</SPAN>&nbsp;<BR>&nbsp;&nbsp;&nbsp;<SPAN class="keyword">[]</SPAN>&nbsp;X<SPAN class="keyword">|</SPAN>Xr&nbsp;<SPAN class="keyword">then</SPAN>&nbsp;<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<SPAN class="keyword">if</SPAN>&nbsp;X<SPAN class="keyword">\=</SPAN>nil&nbsp;<SPAN class="keyword">then</SPAN>&nbsp;Tp&nbsp;<SPAN class="keyword">in</SPAN>&nbsp;<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;PLock=<SPAN class="keyword">unit</SPAN>&nbsp;<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<SPAN class="keyword">if</SPAN>&nbsp;X<SPAN class="keyword">.</SPAN>1<SPAN class="string">'&lt;'</SPAN>RateTh&nbsp;<SPAN class="keyword">then</SPAN>&nbsp;Dif&nbsp;<SPAN class="keyword">in</SPAN>&nbsp;<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<SPAN class="keyword">if</SPAN>&nbsp;{IsDet&nbsp;PrevTime}&nbsp;<SPAN class="keyword">then</SPAN>&nbsp;<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Dif&nbsp;=&nbsp;{Cell<SPAN class="keyword">.</SPAN>access&nbsp;TimeCounter}<SPAN class="keyword">+</SPAN>(X<SPAN class="keyword">.</SPAN>2<SPAN class="keyword">-</SPAN>PrevTime)<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<SPAN class="keyword">else</SPAN>&nbsp;Dif&nbsp;=&nbsp;0&nbsp;<SPAN class="keyword">end</SPAN>&nbsp;<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{Cell<SPAN class="keyword">.</SPAN>assign&nbsp;TimeCounter&nbsp;Dif}<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Tp&nbsp;=&nbsp;TimePeriod<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<SPAN class="keyword">else</SPAN>&nbsp;<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{Cell<SPAN class="keyword">.</SPAN>assign&nbsp;TimeCounter&nbsp;0}<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Tp&nbsp;=&nbsp;2<SPAN class="keyword">*</SPAN>TimePeriod<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<SPAN class="keyword">end</SPAN>&nbsp;<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{WaitFor&nbsp;Tp<SPAN class="keyword">-</SPAN>{Cell<SPAN class="keyword">.</SPAN>access&nbsp;TimeCounter}&nbsp;LLock}<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{GetRate&nbsp;Xr&nbsp;X<SPAN class="keyword">.</SPAN>2&nbsp;LLock}<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<SPAN class="keyword">else</SPAN>&nbsp;<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;PLock=<SPAN class="keyword">unit</SPAN>&nbsp;<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<SPAN class="keyword">if</SPAN>&nbsp;{IsFree&nbsp;Continue}&nbsp;<SPAN class="keyword">then</SPAN>&nbsp;Continue=<SPAN class="keyword">false</SPAN>&nbsp;<SPAN class="keyword">end</SPAN>&nbsp;<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<SPAN class="keyword">end</SPAN>&nbsp;<BR>&nbsp;&nbsp;&nbsp;&nbsp;<SPAN class="keyword">end</SPAN>&nbsp;<BR><SPAN class="keyword">end</SPAN></CODE></DD></DL><P> </P><P><CODE>WaitFor</CODE> procedure is called at each rate occurrence over <CODE>rateStrm</CODE> and is used for terminating the current service if after a given <CODE>Td</CODE> time period the current rate is still below <CODE>RateTh</CODE>. </P><DL><DT><SPAN class="chunktitle"><SPAN class="chunkborder">&lt;</SPAN><A name="label14">WaitFor: wait a period before closing the service</A><SPAN class="chunkborder">&gt;=</SPAN></SPAN></DT><DD class="code"><CODE><SPAN class="keyword">proc</SPAN><SPAN class="variablename">&nbsp;</SPAN>{<SPAN class="functionname">WaitFor</SPAN>&nbsp;Td&nbsp;WLock}<BR>&nbsp;&nbsp;&nbsp;<SPAN class="keyword">thread</SPAN>&nbsp;<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{Delay&nbsp;Td}<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<SPAN class="keyword">if</SPAN>&nbsp;{IsFree&nbsp;WLock}&nbsp;<SPAN class="keyword">then</SPAN>&nbsp;<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Continue=<SPAN class="keyword">true</SPAN>&nbsp;<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{HCObj&nbsp;closeAll(<SPAN class="keyword">false</SPAN>)}<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<SPAN class="keyword">end</SPAN>&nbsp;<BR>&nbsp;&nbsp;&nbsp;<SPAN class="keyword">end</SPAN>&nbsp;<BR><SPAN class="keyword">end</SPAN></CODE></DD></DL><P> </P><H2><A name="label15">3.5 Parallel documents retrieval</A></H2><P>This small example shows how two services can be started in parallel in order to download the same document having different locations <CODE>Url1</CODE> and <CODE>Url2</CODE>. This will try to fetch the documents while each service runs within its own thread. When one of the services completes, it closes the other one and the application exits. Since the two names of the files the document will be saved in will be the same, we set <CODE>overwr</CODE> to <CODE><SPAN class="keyword">false</SPAN></CODE>. Then, by calling <CODE>closeAll</CODE> method with the parameter set to <CODE><SPAN class="keyword">false</SPAN></CODE>, the corresponding file will be removed. Hence, only the file corresponding to the first successful service will remain on the HDD. </P><P class="margin"><A href="http://www.info.ucl.ac.be/%7Evalentin/httpclient/exmpl5.oz">Source File</A></P><P> </P><BLOCKQUOTE><PRE><SPAN class="comment">%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%<BR>%%&nbsp;Parallel&nbsp;document&nbsp;retrieval&nbsp;&nbsp;&nbsp;%%<BR>%%&nbsp;using&nbsp;HttpClient.urlGET&nbsp;class&nbsp;%%<BR>%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%<BR></SPAN><SPAN class="keyword">functor</SPAN>&nbsp;<BR><SPAN class="keyword">import</SPAN>&nbsp;&nbsp;<BR>&nbsp;&nbsp;&nbsp;System<BR>&nbsp;&nbsp;&nbsp;Application<BR>&nbsp;&nbsp;&nbsp;HTTPClient&nbsp;<SPAN class="keyword">at</SPAN>&nbsp;<SPAN class="string">'x-ozlib://mesaros/net/HTTPClient.ozf'</SPAN>&nbsp;&nbsp;<BR><SPAN class="keyword">define</SPAN>&nbsp;<BR>&nbsp;&nbsp;&nbsp;Url1&nbsp;=&nbsp;<SPAN class="string">&quot;http://www.ring.gr.jp/pub/doc/RFC/rfc2616.txt&quot;</SPAN>&nbsp;<BR>&nbsp;&nbsp;&nbsp;Url2&nbsp;=&nbsp;<SPAN class="string">&quot;http://sunsite.doc.ic.ac.uk/rfc/rfc2616.txt&quot;</SPAN>&nbsp;<BR>&nbsp;&nbsp;&nbsp;<SPAN class="keyword">proc</SPAN><SPAN class="variablename">&nbsp;</SPAN>{<SPAN class="functionname">UseIt</SPAN>}<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;HCObj1&nbsp;HCObj2<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;OutPrms1&nbsp;OutPrms2&nbsp;&nbsp;<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ServiceEnd1&nbsp;ServiceEnd2<BR>&nbsp;&nbsp;&nbsp;<SPAN class="keyword">in</SPAN>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;HCObj1={New&nbsp;HTTPClient<SPAN class="keyword">.</SPAN>urlGET&nbsp;init(inPrms(overwr:<SPAN class="keyword">false</SPAN>)&nbsp;_)}<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;HCObj2={New&nbsp;HTTPClient<SPAN class="keyword">.</SPAN>urlGET&nbsp;init(inPrms(overwr:<SPAN class="keyword">false</SPAN>)&nbsp;_)}<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<SPAN class="keyword">thread</SPAN>&nbsp;<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<SPAN class="keyword">try</SPAN>&nbsp;<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{HCObj1&nbsp;getService(Url1&nbsp;OutPrms1&nbsp;_)}<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{System<SPAN class="keyword">.</SPAN>show&nbsp;thread1<SPAN class="keyword">#</SPAN>finished}<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{HCObj2&nbsp;closeAll(<SPAN class="keyword">false</SPAN>)}<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ServiceEnd1=<SPAN class="keyword">unit</SPAN>&nbsp;<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<SPAN class="keyword">catch</SPAN>&nbsp;E&nbsp;<SPAN class="keyword">then</SPAN>&nbsp;<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{System<SPAN class="keyword">.</SPAN>show&nbsp;E}<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ServiceEnd1=<SPAN class="keyword">unit</SPAN>&nbsp;<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<SPAN class="keyword">end</SPAN>&nbsp;<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<SPAN class="keyword">end</SPAN>&nbsp;<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<SPAN class="keyword">thread</SPAN>&nbsp;<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<SPAN class="keyword">try</SPAN>&nbsp;<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{HCObj2&nbsp;getService(Url2&nbsp;OutPrms2&nbsp;_)}<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{System<SPAN class="keyword">.</SPAN>show&nbsp;thread2<SPAN class="keyword">#</SPAN>finished}<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{HCObj1&nbsp;closeAll(<SPAN class="keyword">false</SPAN>)}<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ServiceEnd2=ServiceEnd1&nbsp;&nbsp;&nbsp;&nbsp;<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<SPAN class="keyword">catch</SPAN>&nbsp;E&nbsp;<SPAN class="keyword">then</SPAN>&nbsp;<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{System<SPAN class="keyword">.</SPAN>show&nbsp;E}<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ServiceEnd2=ServiceEnd1<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<SPAN class="keyword">end</SPAN>&nbsp;<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<SPAN class="keyword">end</SPAN>&nbsp;<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{Wait&nbsp;ServiceEnd2}<BR>&nbsp;&nbsp;&nbsp;<SPAN class="keyword">end</SPAN>&nbsp;<BR><SPAN class="keyword">in</SPAN>&nbsp;<BR>&nbsp;&nbsp;&nbsp;{UseIt}<BR>&nbsp;&nbsp;&nbsp;{Application<SPAN class="keyword">.</SPAN>exit&nbsp;0}<BR><SPAN class="keyword">end</SPAN>&nbsp;<BR></PRE></BLOCKQUOTE><P></P><H2><A name="label16">3.6 Avoiding system blocking by using virtual sites</A></H2><P>As we've stated in <A href="node2.html#chapter.httpclient">Chapter&nbsp;2</A>, an HTTP connection implies a socket one, and thus the use of <CODE>connect</CODE> method of <EM>Oz</EM> <CODE>Open<SPAN class="keyword">.</SPAN>socket</CODE> class. This method blocks the entire Oz system until it succeeds, namely until a socket connection is established. Sometimes, this inconvenient becomes really unbearable i.e. when the network is slow, or the peer is off, or does not exist. One solution to solve this inconvenience is to wrap it into a functor and allocate a new process (virtual site) for it. This is done by using the <CODE>Remote</CODE> module.</P><P>The example shown below will try to do something, <CODE>Loop</CODE>, within the current process and download a document in an other one, at the same time. Hence, by using virtual sites we can have parallel jobs running while others blocks for some reasons. The two processes start at the same time but the latter one will block immediately until it succeeds. After succeeded, its transfer rate will be fetched by using the <CODE>fetchRate</CODE> method. </P><P class="margin"><A href="http://www.info.ucl.ac.be/%7Evalentin/httpclient/exmpl6.oz">Source File</A></P><P> </P><BLOCKQUOTE><PRE><SPAN class="comment">%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%<BR>%%&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Avoiding&nbsp;system&nbsp;blocking&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;%%<BR>%%&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;by&nbsp;using&nbsp;Virtual&nbsp;Sites&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;%%<BR>%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%<BR></SPAN><SPAN class="keyword">functor</SPAN>&nbsp;<BR><SPAN class="keyword">import</SPAN>&nbsp;&nbsp;<BR>&nbsp;&nbsp;&nbsp;Application<BR>&nbsp;&nbsp;&nbsp;System<BR>&nbsp;&nbsp;&nbsp;Remote<BR><SPAN class="keyword">define</SPAN>&nbsp;<BR>&nbsp;&nbsp;&nbsp;Funct&nbsp;=&nbsp;<SPAN class="keyword">functor</SPAN>&nbsp;<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<SPAN class="keyword">import</SPAN>&nbsp;<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;System(show:Show)<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;HTTPClient&nbsp;<SPAN class="keyword">at</SPAN>&nbsp;<SPAN class="string">'x-ozlib://mesaros/net/HTTPClient.ozf'</SPAN>&nbsp;<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<SPAN class="keyword">define</SPAN>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<SPAN class="keyword">proc</SPAN><SPAN class="variablename">&nbsp;</SPAN>{<SPAN class="functionname">FetchRate</SPAN>}<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<SPAN class="keyword">if</SPAN>&nbsp;{IsFree&nbsp;ServiceEnd}&nbsp;<SPAN class="keyword">then</SPAN>&nbsp;<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{Delay&nbsp;300}<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{Show&nbsp;rate<SPAN class="keyword">#</SPAN>{HCObj&nbsp;fetchRate($)}<SPAN class="keyword">.</SPAN>1}<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{FetchRate}<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<SPAN class="keyword">end</SPAN>&nbsp;<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<SPAN class="keyword">end</SPAN>&nbsp;&nbsp;<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<SPAN class="keyword">proc</SPAN><SPAN class="variablename">&nbsp;</SPAN>{<SPAN class="functionname">UseIt</SPAN>}&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;HCObj={New&nbsp;HTTPClient<SPAN class="keyword">.</SPAN>urlGET&nbsp;init(_&nbsp;_)}<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<SPAN class="keyword">thread</SPAN>&nbsp;{FetchRate}&nbsp;<SPAN class="keyword">end</SPAN>&nbsp;<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<SPAN class="keyword">try</SPAN>&nbsp;<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{HCObj&nbsp;getService(Url&nbsp;_&nbsp;_)}<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<SPAN class="keyword">catch</SPAN>&nbsp;E&nbsp;<SPAN class="keyword">then</SPAN>&nbsp;<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{Show&nbsp;E}<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<SPAN class="keyword">finally</SPAN>&nbsp;<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ServiceEnd&nbsp;=&nbsp;<SPAN class="keyword">unit</SPAN>&nbsp;<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<SPAN class="keyword">end</SPAN>&nbsp;<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<SPAN class="keyword">end</SPAN>&nbsp;<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;HCObj<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ServiceEnd<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Url=<SPAN class="string">&quot;http://elle.c5.utcluj.ro&quot;</SPAN>&nbsp;<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<SPAN class="keyword">in</SPAN>&nbsp;<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{UseIt}<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<SPAN class="keyword">end</SPAN>&nbsp;<BR>&nbsp;&nbsp;&nbsp;<SPAN class="keyword">proc</SPAN><SPAN class="variablename">&nbsp;</SPAN>{<SPAN class="functionname">Loop</SPAN>&nbsp;N}<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<SPAN class="keyword">if</SPAN>&nbsp;N<SPAN class="keyword">&gt;</SPAN>0&nbsp;<SPAN class="keyword">then</SPAN>&nbsp;<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{Delay&nbsp;100}<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{System<SPAN class="keyword">.</SPAN>show&nbsp;looping<SPAN class="keyword">#</SPAN>N}<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{Loop&nbsp;N<SPAN class="keyword">-</SPAN>1}<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<SPAN class="keyword">end</SPAN>&nbsp;<BR>&nbsp;&nbsp;&nbsp;<SPAN class="keyword">end</SPAN>&nbsp;<BR>&nbsp;&nbsp;&nbsp;<SPAN class="keyword">thread</SPAN>&nbsp;{Loop&nbsp;3000}&nbsp;<SPAN class="keyword">end</SPAN>&nbsp;&nbsp;&nbsp;&nbsp;<BR>&nbsp;&nbsp;&nbsp;R={New&nbsp;Remote<SPAN class="keyword">.</SPAN>manager&nbsp;init}<BR>&nbsp;&nbsp;&nbsp;{R&nbsp;apply(Funct&nbsp;_)}<BR>&nbsp;&nbsp;&nbsp;{Application<SPAN class="keyword">.</SPAN>exit&nbsp;0}<BR><SPAN class="keyword">end</SPAN>&nbsp;<BR></PRE></BLOCKQUOTE><P></P></DIV><TABLE align="center" border="0" cellpadding="6" cellspacing="6" class="nav"><TR bgcolor="#DDDDDD"><TD><A href="node2.html#chapter.httpclient">&lt;&lt; Prev</A></TD><TD><A href="http://www.info.ucl.ac.be/%7Evalentin/httpclient/index.html">- Up -</A></TD><TD><A href="node4.html#chapter.applications">Next &gt;&gt;</A></TD></TR></TABLE><HR><ADDRESS>Valentin Mesaros<BR><SPAN class="version">Version 1.1.1 (20000313)</SPAN></ADDRESS></BODY></HTML>
