<!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.0 Transitional//EN">
<HTML><HEAD><TITLE>5 GlobalStore Demo examples</TITLE><LINK href="ozdoc.css" rel="stylesheet" type="text/css"></HEAD><BODY><TABLE align="center" border="0" cellpadding="6" cellspacing="6" class="nav"><TR bgcolor="#DDDDDD"><TD><A href="node4.html#chapter.examples">&lt;&lt; Prev</A></TD><TD><A href="index.html">- Up -</A></TD><TD><A href="node6.html#chapter.simulate">Next &gt;&gt;</A></TD></TR></TABLE><DIV id="chapter.demos"><H1><A name="chapter.demos">5 <CODE>GlobalStore</CODE> Demo examples</A></H1><P>In this chapter we'll present some concrete applications which use some functionality provided by this package. </P><DIV id="section.globalstore.draw"><H2><A name="section.globalstore.draw">5.1 Faut-tolerant Collaborative drawing application </A></H2><P> The application example is a multi-user drawing application. Each user have its own drawing area. A user draws rectangles on the drawing area and moves them with the mouse. The abstraction maintains the coherence of all user's display. The following original centralised program uses the <A href="/mogul/info/grolaux/qtk.html">QTk Module</A>. It shows how graphics objects can be controlled on a canvas. We can create rectangles, click on them and drag them with the mouse. </P><P class="margin"><A href="cent_draw.oz">Source File</A></P><P> </P><BLOCKQUOTE><PRE><SPAN class="keyword">functor</SPAN>&nbsp;<BR><SPAN class="keyword">import</SPAN>&nbsp;<BR>&nbsp;&nbsp;&nbsp;QTk<BR><SPAN class="keyword">export</SPAN>&nbsp;<BR><SPAN class="keyword">define</SPAN>&nbsp;<BR>&nbsp;&nbsp;Canvas<BR>&nbsp;&nbsp;Desc=td(canvas(&nbsp;handle:Canvas<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;glue:nswe<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;bg:white))&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<BR>&nbsp;&nbsp;&nbsp;Window={QTk<SPAN class="keyword">.</SPAN>build&nbsp;Desc}&nbsp;&nbsp;&nbsp;&nbsp;<BR>&nbsp;&nbsp;&nbsp;ListColors=&nbsp;[red&nbsp;green&nbsp;blue&nbsp;yellow]<BR>&nbsp;&nbsp;&nbsp;Colors={NewCell&nbsp;ListColors}<BR>&nbsp;&nbsp;&nbsp;<SPAN class="keyword">proc</SPAN>{<SPAN class="functionname">CreateRectangle</SPAN>&nbsp;X&nbsp;Y}<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Tag<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Col<BR>&nbsp;&nbsp;&nbsp;<SPAN class="keyword">in</SPAN>&nbsp;<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Tag={Canvas&nbsp;newTag($)}<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<SPAN class="keyword">case</SPAN>&nbsp;{Access&nbsp;Colors&nbsp;$}&nbsp;<SPAN class="keyword">of</SPAN>&nbsp;<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Color<SPAN class="keyword">|</SPAN>_&nbsp;<SPAN class="keyword">then</SPAN>&nbsp;Col=Color&nbsp;&nbsp;<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<SPAN class="keyword">[]</SPAN>&nbsp;nil&nbsp;<SPAN class="keyword">then</SPAN>&nbsp;{Assign&nbsp;Colors&nbsp;ListColors}&nbsp;Col=red<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<SPAN class="keyword">end</SPAN>&nbsp;&nbsp;&nbsp;&nbsp;<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{Assign&nbsp;Colors&nbsp;{List<SPAN class="keyword">.</SPAN>drop&nbsp;{Access&nbsp;Colors&nbsp;$}&nbsp;1&nbsp;$}}<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{Canvas&nbsp;create(rectangle&nbsp;X<SPAN class="keyword">-</SPAN>50&nbsp;Y<SPAN class="keyword">-</SPAN>50&nbsp;X<SPAN class="keyword">+</SPAN>50&nbsp;Y<SPAN class="keyword">+</SPAN>50&nbsp;fill:Col&nbsp;tags:Tag)}<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{Bindevent&nbsp;Tag}&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<BR>&nbsp;&nbsp;&nbsp;<SPAN class="keyword">end</SPAN>&nbsp;<BR>&nbsp;&nbsp;&nbsp;<SPAN class="keyword">proc</SPAN><SPAN class="variablename">&nbsp;</SPAN>{<SPAN class="functionname">Bindevent</SPAN>&nbsp;Tag}&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{Tag&nbsp;bind(event:<SPAN class="string">&quot;&lt;B1-ButtonRelease&gt;&quot;</SPAN>&nbsp;<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;args:[int(x)&nbsp;int(y)]<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;action:<SPAN class="keyword">proc</SPAN>{<SPAN class="functionname">$</SPAN>&nbsp;X&nbsp;Y}<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{Tag&nbsp;setCoords(X<SPAN class="keyword">-</SPAN>50&nbsp;Y<SPAN class="keyword">-</SPAN>50&nbsp;X<SPAN class="keyword">+</SPAN>50&nbsp;Y<SPAN class="keyword">+</SPAN>50)}<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<SPAN class="keyword">end</SPAN>)}<BR>&nbsp;&nbsp;&nbsp;<SPAN class="keyword">end</SPAN>&nbsp;<BR>&nbsp;&nbsp;&nbsp;{Canvas&nbsp;bind(event:<SPAN class="string">&quot;&lt;2&gt;&quot;</SPAN>&nbsp;<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;args:[int(x)&nbsp;int(y)&nbsp;]<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;action:CreateRectangle)}&nbsp;&nbsp;<BR><SPAN class="keyword">in</SPAN>&nbsp;&nbsp;&nbsp;<BR>&nbsp;{Window&nbsp;show(wait:<SPAN class="keyword">true</SPAN>)}<BR><SPAN class="keyword">end</SPAN>&nbsp;<BR></PRE></BLOCKQUOTE><P></P><P> To make the drawing program a fault tolerant distributed application, the original centralised program is modified in the following way: First, we create a new global store. </P><P class="margin"><A href="newgs.oz">Source File</A></P><P> </P><BLOCKQUOTE><PRE><SPAN class="comment">%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%<BR>%&nbsp;Create&nbsp;a&nbsp;new&nbsp;global&nbsp;store<BR>%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%<BR></SPAN><SPAN class="keyword">functor</SPAN>&nbsp;<BR><SPAN class="keyword">import</SPAN>&nbsp;<BR>&nbsp;&nbsp;&nbsp;OS<BR>&nbsp;&nbsp;&nbsp;Open<BR>&nbsp;&nbsp;&nbsp;GlobalStore(newStore:NewStore)&nbsp;&nbsp;<BR>&nbsp;&nbsp;&nbsp;Application<BR>&nbsp;&nbsp;&nbsp;Connection<BR>&nbsp;&nbsp;&nbsp;Pickle<BR>&nbsp;&nbsp;&nbsp;System(show:Show)<BR><SPAN class="keyword">define</SPAN>&nbsp;<BR>&nbsp;&nbsp;&nbsp;Pid&nbsp;F<BR>&nbsp;&nbsp;&nbsp;Ls<BR>&nbsp;&nbsp;&nbsp;<SPAN class="comment">%%%&nbsp;Store&nbsp;emulator&nbsp;pid&nbsp;in&nbsp;a&nbsp;file&nbsp;:&nbsp;user&nbsp;by&nbsp;the&nbsp;test&nbsp;failure&nbsp;script&nbsp;&nbsp;<BR></SPAN>&nbsp;&nbsp;&nbsp;<SPAN class="keyword">try</SPAN>&nbsp;<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Pid={OS<SPAN class="keyword">.</SPAN>getPID}<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;F={New&nbsp;Open<SPAN class="keyword">.</SPAN>file&nbsp;init(name:<SPAN class="string">'/tmp/pidserver'</SPAN>&nbsp;flags:[write&nbsp;create])}&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{F&nbsp;write(vs:Pid)}<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{F&nbsp;close}<BR>&nbsp;&nbsp;&nbsp;<SPAN class="keyword">catch</SPAN>&nbsp;<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;error(_)<BR>&nbsp;&nbsp;&nbsp;<SPAN class="keyword">then</SPAN>&nbsp;<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{Show&nbsp;<SPAN class="string">'ErrorCreateFile'</SPAN>}<BR>&nbsp;&nbsp;&nbsp;<SPAN class="keyword">end</SPAN>&nbsp;&nbsp;&nbsp;&nbsp;<BR>&nbsp;&nbsp;&nbsp;&nbsp;<BR>&nbsp;&nbsp;&nbsp;<SPAN class="keyword">try</SPAN>&nbsp;<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{NewStore&nbsp;?Ls}<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<SPAN class="comment">%&nbsp;pickle&nbsp;LS&nbsp;and&nbsp;offer&nbsp;it&nbsp;to&nbsp;clients<BR></SPAN>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{Pickle<SPAN class="keyword">.</SPAN>save&nbsp;{Connection<SPAN class="keyword">.</SPAN>offerUnlimited&nbsp;Ls&nbsp;$}&nbsp;<SPAN class="string">'./gsticket'</SPAN>}<BR>&nbsp;&nbsp;&nbsp;<SPAN class="keyword">catch</SPAN>&nbsp;<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;gs(failed_globalstore_creation)&nbsp;<SPAN class="keyword">then</SPAN>&nbsp;<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{Show&nbsp;errorNewStore&nbsp;}{Application<SPAN class="keyword">.</SPAN>exit&nbsp;0}&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<BR>&nbsp;&nbsp;&nbsp;<SPAN class="keyword">[]</SPAN>&nbsp;error(url(_&nbsp;_)&nbsp;debug:_)&nbsp;<SPAN class="keyword">then</SPAN>&nbsp;{Show&nbsp;<SPAN class="string">'cannot&nbsp;create&nbsp;url&nbsp;or&nbsp;file&nbsp;'</SPAN>}<BR>&nbsp;&nbsp;&nbsp;<SPAN class="keyword">[]</SPAN>&nbsp;error(connection(_&nbsp;_)&nbsp;&nbsp;debug:_)&nbsp;&nbsp;<SPAN class="keyword">then</SPAN>&nbsp;{Show&nbsp;<SPAN class="string">'connection&nbsp;Module&nbsp;error'</SPAN>}<BR>&nbsp;&nbsp;&nbsp;<SPAN class="keyword">end</SPAN>&nbsp;<BR><SPAN class="keyword">end</SPAN>&nbsp;<BR></PRE></BLOCKQUOTE><P></P><P> Second, we modify the original centralised code by connecting the new user to the global store and using transactions when we update rectangle objects. </P><P class="margin"><A href="draw1.oz">Source File</A></P><P> </P><BLOCKQUOTE><PRE><SPAN class="comment">%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%<BR>%%&nbsp;Example&nbsp;illustrating&nbsp;the&nbsp;GS<BR>%%&nbsp;Author&nbsp;Ilies&nbsp;Alouini<BR>%%&nbsp;Last&nbsp;Modification&nbsp;9-9-2000<BR>%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%<BR></SPAN><SPAN class="keyword">functor</SPAN>&nbsp;<BR><SPAN class="keyword">import</SPAN>&nbsp;&nbsp;<BR>&nbsp;&nbsp;&nbsp;System(show:Show)<BR>&nbsp;&nbsp;&nbsp;Module<BR>&nbsp;&nbsp;&nbsp;Pickle<BR>&nbsp;&nbsp;&nbsp;Connection<BR>&nbsp;&nbsp;&nbsp;Application<BR><SPAN class="keyword">export</SPAN>&nbsp;<BR><SPAN class="keyword">define</SPAN>&nbsp;<BR>&nbsp;&nbsp;&nbsp;<SPAN class="comment">%%%&nbsp;rectangle&nbsp;object&nbsp;class&nbsp;in&nbsp;the&nbsp;Global&nbsp;Store<BR></SPAN>&nbsp;&nbsp;&nbsp;<SPAN class="keyword">class</SPAN>&nbsp;<SPAN class="type">Rectangle</SPAN>&nbsp;<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<SPAN class="keyword">prop</SPAN>&nbsp;locking<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<SPAN class="keyword">attr</SPAN>&nbsp;<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ox:0<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;oy:0<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;order<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;color<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<SPAN class="keyword">meth</SPAN>&nbsp;<SPAN class="functionname">init</SPAN>(X&nbsp;Y&nbsp;Order&nbsp;Color)<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ox&nbsp;<SPAN class="keyword">&lt;-</SPAN>&nbsp;X<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;oy&nbsp;<SPAN class="keyword">&lt;-</SPAN>&nbsp;Y<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;order&nbsp;<SPAN class="keyword">&lt;-</SPAN>&nbsp;Order<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;color&nbsp;<SPAN class="keyword">&lt;-</SPAN>&nbsp;Color<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<SPAN class="keyword">end</SPAN>&nbsp;<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<SPAN class="keyword">meth</SPAN>&nbsp;<SPAN class="functionname">getcoord</SPAN>(X&nbsp;Y)<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<SPAN class="keyword">lock</SPAN>&nbsp;<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;X=<SPAN class="keyword">@</SPAN>ox<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Y=<SPAN class="keyword">@</SPAN>oy<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<SPAN class="keyword">end</SPAN>&nbsp;<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<SPAN class="keyword">end</SPAN>&nbsp;<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<SPAN class="keyword">meth</SPAN>&nbsp;<SPAN class="functionname">setcoord</SPAN>(X&nbsp;Y)<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<SPAN class="keyword">lock</SPAN>&nbsp;<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ox&nbsp;<SPAN class="keyword">&lt;-</SPAN>&nbsp;X&nbsp;&nbsp;<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;oy&nbsp;<SPAN class="keyword">&lt;-</SPAN>&nbsp;Y&nbsp;&nbsp;<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<SPAN class="keyword">end</SPAN>&nbsp;<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<SPAN class="keyword">end</SPAN>&nbsp;<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<SPAN class="keyword">meth</SPAN>&nbsp;<SPAN class="functionname">getorder</SPAN>(O)<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;O=<SPAN class="keyword">@</SPAN>order<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<SPAN class="keyword">end</SPAN>&nbsp;<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<SPAN class="keyword">meth</SPAN>&nbsp;<SPAN class="functionname">getcolor</SPAN>(Col)<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Col=<SPAN class="keyword">@</SPAN>color<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<SPAN class="keyword">end</SPAN>&nbsp;<BR>&nbsp;&nbsp;&nbsp;<SPAN class="keyword">end</SPAN>&nbsp;<BR>&nbsp;&nbsp;&nbsp;&nbsp;<BR>&nbsp;&nbsp;&nbsp;[QTk]={Module<SPAN class="keyword">.</SPAN>link&nbsp;[<SPAN class="string">&quot;./QTk.ozf&quot;</SPAN>]}&nbsp;&nbsp;&nbsp;<BR>&nbsp;&nbsp;&nbsp;Canvas<BR>&nbsp;&nbsp;&nbsp;Desc=td(canvas(<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;handle:Canvas<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;glue:nswe<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;bg:white))<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<SPAN class="comment">%tdscrollbar:true<BR></SPAN>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<SPAN class="comment">%lrscrollbar:true))&nbsp;&nbsp;&nbsp;&nbsp;<BR></SPAN>&nbsp;&nbsp;&nbsp;Window={QTk<SPAN class="keyword">.</SPAN>build&nbsp;Desc}&nbsp;&nbsp;&nbsp;&nbsp;<BR>&nbsp;&nbsp;&nbsp;&nbsp;<BR>&nbsp;&nbsp;&nbsp;<SPAN class="comment">%%%%%%%&nbsp;Dictionary&nbsp;of&nbsp;pairs&nbsp;order&nbsp;store&nbsp;object,&nbsp;store&nbsp;object#graphic&nbsp;object<BR></SPAN>&nbsp;&nbsp;&nbsp;Dictobjects={NewDictionary&nbsp;$}<BR>&nbsp;&nbsp;&nbsp;NewObj&nbsp;LocalStore&nbsp;&nbsp;Movehere&nbsp;LS<BR>&nbsp;&nbsp;&nbsp;ListColors=&nbsp;[red&nbsp;green&nbsp;blue&nbsp;yellow]<BR>&nbsp;&nbsp;&nbsp;Colors={NewCell&nbsp;ListColors}<BR>&nbsp;&nbsp;&nbsp;<SPAN class="keyword">proc</SPAN>{<SPAN class="functionname">UpdateRectangle</SPAN>&nbsp;X&nbsp;Y&nbsp;Obj&nbsp;?Tag}&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Tag={Canvas&nbsp;newTag($)}&nbsp;&nbsp;<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{Canvas&nbsp;create(rectangle&nbsp;X<SPAN class="keyword">-</SPAN>50&nbsp;Y<SPAN class="keyword">-</SPAN>50&nbsp;X<SPAN class="keyword">+</SPAN>50&nbsp;Y<SPAN class="keyword">+</SPAN>50&nbsp;fill:{Obj&nbsp;getcolor($)}&nbsp;tags:Tag)}<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{Bindevent&nbsp;Tag&nbsp;Obj}&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<BR>&nbsp;&nbsp;&nbsp;<SPAN class="keyword">end</SPAN>&nbsp;<BR>&nbsp;&nbsp;&nbsp;<SPAN class="keyword">proc</SPAN>{<SPAN class="functionname">CreateRectangle</SPAN>&nbsp;X&nbsp;Y}<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Order&nbsp;Sobj&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Tag<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Col<BR>&nbsp;&nbsp;&nbsp;<SPAN class="keyword">in</SPAN>&nbsp;<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Tag={Canvas&nbsp;newTag($)}<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<SPAN class="keyword">case</SPAN>&nbsp;{Access&nbsp;Colors&nbsp;$}&nbsp;<SPAN class="keyword">of</SPAN>&nbsp;<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Color<SPAN class="keyword">|</SPAN>_&nbsp;<SPAN class="keyword">then</SPAN>&nbsp;Col=Color&nbsp;&nbsp;<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<SPAN class="keyword">[]</SPAN>&nbsp;nil&nbsp;<SPAN class="keyword">then</SPAN>&nbsp;{Assign&nbsp;Colors&nbsp;ListColors}&nbsp;Col=red<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<SPAN class="keyword">end</SPAN>&nbsp;<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{Assign&nbsp;Colors&nbsp;{List<SPAN class="keyword">.</SPAN>drop&nbsp;{Access&nbsp;Colors&nbsp;$}&nbsp;1&nbsp;$}}&nbsp;&nbsp;&nbsp;<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<SPAN class="keyword">try</SPAN>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Sobj={NewObj&nbsp;&nbsp;Rectangle&nbsp;init(X&nbsp;Y&nbsp;&nbsp;Order&nbsp;Col)}<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{Canvas&nbsp;create(rectangle&nbsp;X<SPAN class="keyword">-</SPAN>50&nbsp;Y<SPAN class="keyword">-</SPAN>50&nbsp;X<SPAN class="keyword">+</SPAN>50&nbsp;Y<SPAN class="keyword">+</SPAN>50&nbsp;fill:Col&nbsp;tags:Tag)}<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{LocalStore&nbsp;getuniqueident(?Order)}&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{Dictionary<SPAN class="keyword">.</SPAN>put&nbsp;Dictobjects&nbsp;Order&nbsp;Sobj<SPAN class="keyword">#</SPAN>Tag}<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{Bindevent&nbsp;Tag&nbsp;Sobj}&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<BR>&nbsp;&nbsp;&nbsp;<SPAN class="keyword">catch</SPAN>&nbsp;gs(global_store_temporary_failed)&nbsp;<SPAN class="keyword">then</SPAN>&nbsp;<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{Show&nbsp;<SPAN class="string">'Object&nbsp;not&nbsp;created:&nbsp;retry'</SPAN>}<BR>&nbsp;&nbsp;&nbsp;<SPAN class="keyword">end</SPAN>&nbsp;<BR>&nbsp;&nbsp;&nbsp;<SPAN class="keyword">end</SPAN>&nbsp;&nbsp;&nbsp;<BR>&nbsp;&nbsp;&nbsp;<SPAN class="keyword">proc</SPAN><SPAN class="variablename">&nbsp;</SPAN>{<SPAN class="functionname">Bindevent</SPAN>&nbsp;Tag&nbsp;&nbsp;Sobj}&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{Tag&nbsp;bind(event:<SPAN class="string">&quot;&lt;B1-ButtonRelease&gt;&quot;</SPAN>&nbsp;<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;args:[int(x)&nbsp;int(y)]<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;action:<SPAN class="keyword">proc</SPAN>{<SPAN class="functionname">$</SPAN>&nbsp;X&nbsp;Y}<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Out&nbsp;Transid<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<SPAN class="keyword">proc</SPAN><SPAN class="variablename">&nbsp;</SPAN>{<SPAN class="functionname">Trans</SPAN>&nbsp;Output}<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{Sobj&nbsp;setcoord(X&nbsp;Y)}<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<SPAN class="keyword">end</SPAN>&nbsp;<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<SPAN class="keyword">in</SPAN>&nbsp;<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<SPAN class="comment">%{Canvas&nbsp;canvasx(OX&nbsp;?X)}<BR></SPAN>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<SPAN class="comment">%{Canvas&nbsp;canvasy(OY&nbsp;?Y)}&nbsp;&nbsp;<BR></SPAN>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{Tag&nbsp;setCoords(X<SPAN class="keyword">-</SPAN>50&nbsp;Y<SPAN class="keyword">-</SPAN>50&nbsp;X<SPAN class="keyword">+</SPAN>50&nbsp;Y<SPAN class="keyword">+</SPAN>50)}<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<SPAN class="comment">%&nbsp;initialise&nbsp;transaction&nbsp;on&nbsp;Tag<BR></SPAN>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{LocalStore&nbsp;trans(Trans&nbsp;Out&nbsp;Transid)}<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<SPAN class="comment">%{LocalStore&nbsp;checktrans(Transid&nbsp;Res&nbsp;_)}&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<BR></SPAN>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<SPAN class="keyword">end</SPAN>)}<BR>&nbsp;&nbsp;&nbsp;<SPAN class="keyword">end</SPAN>&nbsp;<BR>&nbsp;&nbsp;&nbsp;{Canvas&nbsp;bind(event:<SPAN class="string">&quot;&lt;2&gt;&quot;</SPAN>&nbsp;<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;args:[int(x)&nbsp;int(y)&nbsp;]<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;action:CreateRectangle)}<BR>&nbsp;<BR>&nbsp;&nbsp;&nbsp;<BR>&nbsp;&nbsp;&nbsp;RedrawAll<BR><SPAN class="keyword">in</SPAN>&nbsp;<BR>&nbsp;&nbsp;&nbsp;<SPAN class="comment">%%%%%%%%%%%%%%%%%%%%%%%%%<BR></SPAN>&nbsp;&nbsp;&nbsp;<SPAN class="comment">%%&nbsp;Initiate&nbsp;a&nbsp;local&nbsp;store<BR></SPAN>&nbsp;&nbsp;&nbsp;<SPAN class="comment">%%%%%%%%%%%%%%%%%%%%%%%%%&nbsp;&nbsp;&nbsp;<BR></SPAN>&nbsp;&nbsp;&nbsp;<SPAN class="keyword">try</SPAN>&nbsp;LS={Connection<SPAN class="keyword">.</SPAN>take&nbsp;{Pickle<SPAN class="keyword">.</SPAN>load&nbsp;<SPAN class="string">'./gsticket'</SPAN>&nbsp;$}}<BR>&nbsp;&nbsp;&nbsp;<SPAN class="keyword">catch</SPAN>&nbsp;<BR>&nbsp;&nbsp;&nbsp;&nbsp;error(url(_&nbsp;_)&nbsp;debug:_)&nbsp;<SPAN class="keyword">then</SPAN>&nbsp;{Show&nbsp;<SPAN class="string">'url&nbsp;or&nbsp;file&nbsp;not&nbsp;found'</SPAN>}<BR>&nbsp;&nbsp;&nbsp;<SPAN class="keyword">[]</SPAN>&nbsp;error(connection(_&nbsp;_)&nbsp;&nbsp;debug:_)&nbsp;&nbsp;<SPAN class="keyword">then</SPAN>&nbsp;{Show&nbsp;connectionfailed}<BR>&nbsp;&nbsp;&nbsp;<SPAN class="keyword">end</SPAN>&nbsp;<BR>&nbsp;&nbsp;&nbsp;&nbsp;<BR>&nbsp;&nbsp;&nbsp;<SPAN class="keyword">try</SPAN>&nbsp;<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{LS&nbsp;newLocal(Module&nbsp;user1&nbsp;&nbsp;?NewObj&nbsp;?LocalStore&nbsp;?Movehere)}<BR>&nbsp;&nbsp;&nbsp;<SPAN class="keyword">catch</SPAN>&nbsp;gs(connectionfailed)<BR>&nbsp;&nbsp;&nbsp;<SPAN class="keyword">then</SPAN>&nbsp;<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{Show&nbsp;connectionfailed}<BR>&nbsp;&nbsp;&nbsp;<SPAN class="keyword">end</SPAN>&nbsp;<BR>&nbsp;&nbsp;&nbsp;<SPAN class="keyword">try</SPAN>&nbsp;{Pickle<SPAN class="keyword">.</SPAN>save&nbsp;{Connection<SPAN class="keyword">.</SPAN>offerUnlimited&nbsp;LocalStore&nbsp;$}&nbsp;<SPAN class="string">'./client1ticket'</SPAN>}<BR>&nbsp;&nbsp;&nbsp;<SPAN class="keyword">catch</SPAN>&nbsp;<BR>&nbsp;&nbsp;&nbsp;&nbsp;error(url(_&nbsp;_)&nbsp;debug:_)&nbsp;<SPAN class="keyword">then</SPAN>&nbsp;{Show&nbsp;<SPAN class="string">'cannot&nbsp;create&nbsp;url&nbsp;or&nbsp;file&nbsp;'</SPAN>}<BR>&nbsp;&nbsp;&nbsp;<SPAN class="keyword">[]</SPAN>&nbsp;error(connection(_&nbsp;_)&nbsp;&nbsp;debug:_)&nbsp;&nbsp;<SPAN class="keyword">then</SPAN>&nbsp;{Show&nbsp;<SPAN class="string">'connection&nbsp;Module&nbsp;error'</SPAN>}<BR>&nbsp;&nbsp;&nbsp;<SPAN class="keyword">end</SPAN>&nbsp;<BR>&nbsp;&nbsp;&nbsp;<SPAN class="comment">%%%&nbsp;Save&nbsp;the&nbsp;MOvehere&nbsp;procedure<BR></SPAN>&nbsp;&nbsp;&nbsp;<SPAN class="keyword">try</SPAN>&nbsp;{Pickle<SPAN class="keyword">.</SPAN>save&nbsp;{Connection<SPAN class="keyword">.</SPAN>offerUnlimited&nbsp;Movehere&nbsp;$}&nbsp;<SPAN class="string">'./movehereticket'</SPAN>}<BR>&nbsp;&nbsp;&nbsp;<SPAN class="keyword">catch</SPAN>&nbsp;<BR>&nbsp;&nbsp;&nbsp;&nbsp;error(url(_&nbsp;_)&nbsp;debug:_)&nbsp;<SPAN class="keyword">then</SPAN>&nbsp;{Show&nbsp;<SPAN class="string">'cannot&nbsp;create&nbsp;url&nbsp;or&nbsp;file&nbsp;'</SPAN>}<BR>&nbsp;&nbsp;&nbsp;<SPAN class="keyword">[]</SPAN>&nbsp;error(connection(_&nbsp;_)&nbsp;&nbsp;debug:_)&nbsp;&nbsp;<SPAN class="keyword">then</SPAN>&nbsp;{Show&nbsp;<SPAN class="string">'connection&nbsp;Module&nbsp;error'</SPAN>}<BR>&nbsp;&nbsp;&nbsp;<SPAN class="keyword">end</SPAN>&nbsp;&nbsp;<BR>&nbsp;&nbsp;&nbsp;<SPAN class="comment">%&nbsp;set&nbsp;action&nbsp;when&nbsp;object&nbsp;creation<BR></SPAN>&nbsp;&nbsp;&nbsp;{LocalStore&nbsp;setnotifycreation(<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<SPAN class="keyword">proc</SPAN><SPAN class="variablename">&nbsp;</SPAN>{<SPAN class="functionname">$</SPAN>&nbsp;O}<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Tag&nbsp;X&nbsp;Y&nbsp;Ord&nbsp;<SPAN class="keyword">in</SPAN>&nbsp;<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{O&nbsp;getorder(Ord)}<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{Wait&nbsp;Ord}<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{O&nbsp;getcoord(X&nbsp;Y)}<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{UpdateRectangle&nbsp;X&nbsp;Y&nbsp;O&nbsp;?Tag}<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{Dictionary<SPAN class="keyword">.</SPAN>put&nbsp;&nbsp;Dictobjects&nbsp;Ord&nbsp;&nbsp;O<SPAN class="keyword">#</SPAN>Tag}<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<SPAN class="keyword">end</SPAN>)}<BR>&nbsp;&nbsp;&nbsp;<SPAN class="comment">%%%%&nbsp;Redraw&nbsp;All&nbsp;Objects<BR></SPAN>&nbsp;&nbsp;&nbsp;<SPAN class="keyword">proc</SPAN><SPAN class="variablename">&nbsp;</SPAN>{<SPAN class="functionname">RedrawAll</SPAN>}<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Entries&nbsp;En&nbsp;&nbsp;<SPAN class="keyword">in</SPAN>&nbsp;<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<SPAN class="comment">%&nbsp;sort&nbsp;Graphic&nbsp;objects<BR></SPAN>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{Dictionary<SPAN class="keyword">.</SPAN>keys&nbsp;Dictobjects&nbsp;?Entries}<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{List<SPAN class="keyword">.</SPAN>sort&nbsp;Entries&nbsp;Value<SPAN class="keyword">.</SPAN><SPAN class="string">'&lt;'</SPAN>&nbsp;?En}&nbsp;&nbsp;<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<SPAN class="comment">%&nbsp;redraw&nbsp;all&nbsp;objects&nbsp;in&nbsp;order<BR></SPAN>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{ForAll&nbsp;En<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<SPAN class="keyword">proc</SPAN><SPAN class="variablename">&nbsp;</SPAN>{<SPAN class="functionname">$</SPAN>&nbsp;Order}<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;O&nbsp;&nbsp;X&nbsp;Y&nbsp;Tag&nbsp;&nbsp;&nbsp;Go&nbsp;<SPAN class="keyword">in</SPAN>&nbsp;<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{Dictionary<SPAN class="keyword">.</SPAN>get&nbsp;Dictobjects&nbsp;Order&nbsp;&nbsp;O<SPAN class="keyword">#</SPAN>Go}<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{Go&nbsp;delete}&nbsp;&nbsp;&nbsp;&nbsp;<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{O&nbsp;getcoord(X&nbsp;Y)}<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{UpdateRectangle&nbsp;X&nbsp;Y&nbsp;O&nbsp;?Tag}<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{Dictionary<SPAN class="keyword">.</SPAN>remove&nbsp;Dictobjects&nbsp;Order}<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{Dictionary<SPAN class="keyword">.</SPAN>put&nbsp;Dictobjects&nbsp;Order&nbsp;O<SPAN class="keyword">#</SPAN>Tag}<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<SPAN class="keyword">end</SPAN>&nbsp;<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}<BR>&nbsp;&nbsp;&nbsp;&nbsp;<SPAN class="keyword">end</SPAN>&nbsp;<BR>&nbsp;&nbsp;&nbsp;<SPAN class="comment">%&nbsp;set&nbsp;action&nbsp;when&nbsp;receiving&nbsp;Obj&nbsp;object&nbsp;update<BR></SPAN>&nbsp;&nbsp;&nbsp;{LocalStore&nbsp;setnotifyupdate(<BR>&nbsp;&nbsp;&nbsp;&nbsp;<SPAN class="keyword">proc</SPAN><SPAN class="variablename">&nbsp;</SPAN>{<SPAN class="functionname">$</SPAN>&nbsp;?Obj}<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{RedrawAll}<BR>&nbsp;&nbsp;&nbsp;&nbsp;<SPAN class="keyword">end</SPAN>)<BR>&nbsp;&nbsp;&nbsp;}<BR>&nbsp;&nbsp;&nbsp;{LocalStore&nbsp;setnotifyabort(<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<SPAN class="keyword">proc</SPAN><SPAN class="variablename">&nbsp;</SPAN>{<SPAN class="functionname">$</SPAN>&nbsp;?Obj}<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{RedrawAll}<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<SPAN class="keyword">end</SPAN>&nbsp;<BR>&nbsp;&nbsp;&nbsp;&nbsp;)<BR>&nbsp;&nbsp;&nbsp;}&nbsp;&nbsp;<BR>&nbsp;{Window&nbsp;show(wait:<SPAN class="keyword">true</SPAN>)}<BR><SPAN class="keyword">end</SPAN>&nbsp;<BR></PRE></BLOCKQUOTE><P></P><P> We can now create another new user connected to GS: </P><P class="margin"><A href="draw2.oz">Source File</A></P><P> </P><BLOCKQUOTE><PRE><SPAN class="comment">%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%<BR>%%&nbsp;Example&nbsp;illustrating&nbsp;the&nbsp;GS<BR>%%&nbsp;Author&nbsp;Ilies&nbsp;Alouini<BR>%%&nbsp;Last&nbsp;Modification&nbsp;9-9-2000<BR>%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%<BR></SPAN><SPAN class="keyword">functor</SPAN>&nbsp;<BR><SPAN class="keyword">import</SPAN>&nbsp;&nbsp;<BR>&nbsp;&nbsp;&nbsp;System(show:Show)<BR>&nbsp;&nbsp;&nbsp;Module<BR>&nbsp;&nbsp;&nbsp;Application<BR>&nbsp;&nbsp;&nbsp;Connection<BR>&nbsp;&nbsp;&nbsp;Pickle<BR><SPAN class="keyword">export</SPAN>&nbsp;<BR><SPAN class="keyword">define</SPAN>&nbsp;<BR>&nbsp;&nbsp;&nbsp;<SPAN class="comment">%%%&nbsp;rectangle&nbsp;object&nbsp;class&nbsp;in&nbsp;the&nbsp;Global&nbsp;Store<BR></SPAN>&nbsp;&nbsp;&nbsp;<SPAN class="keyword">class</SPAN>&nbsp;<SPAN class="type">Rectangle</SPAN>&nbsp;<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<SPAN class="keyword">prop</SPAN>&nbsp;locking<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<SPAN class="keyword">attr</SPAN>&nbsp;<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ox:0<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;oy:0<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;order<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;color<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<SPAN class="keyword">meth</SPAN>&nbsp;<SPAN class="functionname">init</SPAN>(X&nbsp;Y&nbsp;Order&nbsp;Color)<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ox&nbsp;<SPAN class="keyword">&lt;-</SPAN>&nbsp;X<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;oy&nbsp;<SPAN class="keyword">&lt;-</SPAN>&nbsp;Y<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;order&nbsp;<SPAN class="keyword">&lt;-</SPAN>&nbsp;Order<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;color&nbsp;<SPAN class="keyword">&lt;-</SPAN>&nbsp;Color<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<SPAN class="keyword">end</SPAN>&nbsp;<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<SPAN class="keyword">meth</SPAN>&nbsp;<SPAN class="functionname">getcoord</SPAN>(X&nbsp;Y)<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<SPAN class="keyword">lock</SPAN>&nbsp;<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;X=<SPAN class="keyword">@</SPAN>ox<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Y=<SPAN class="keyword">@</SPAN>oy<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<SPAN class="keyword">end</SPAN>&nbsp;<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<SPAN class="keyword">end</SPAN>&nbsp;<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<SPAN class="keyword">meth</SPAN>&nbsp;<SPAN class="functionname">setcoord</SPAN>(X&nbsp;Y)<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<SPAN class="keyword">lock</SPAN>&nbsp;<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ox&nbsp;<SPAN class="keyword">&lt;-</SPAN>&nbsp;X&nbsp;&nbsp;<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;oy&nbsp;<SPAN class="keyword">&lt;-</SPAN>&nbsp;Y&nbsp;&nbsp;<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<SPAN class="keyword">end</SPAN>&nbsp;<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<SPAN class="keyword">end</SPAN>&nbsp;<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<SPAN class="keyword">meth</SPAN>&nbsp;<SPAN class="functionname">getorder</SPAN>(O)<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;O=<SPAN class="keyword">@</SPAN>order<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<SPAN class="keyword">end</SPAN>&nbsp;<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<SPAN class="keyword">meth</SPAN>&nbsp;<SPAN class="functionname">getcolor</SPAN>(Col)<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Col=<SPAN class="keyword">@</SPAN>color<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<SPAN class="keyword">end</SPAN>&nbsp;<BR>&nbsp;&nbsp;&nbsp;<SPAN class="keyword">end</SPAN>&nbsp;<BR>&nbsp;&nbsp;&nbsp;&nbsp;<BR>&nbsp;&nbsp;&nbsp;[QTk]={Module<SPAN class="keyword">.</SPAN>link&nbsp;[<SPAN class="string">&quot;./QTk.ozf&quot;</SPAN>]}&nbsp;&nbsp;&nbsp;<BR>&nbsp;&nbsp;&nbsp;Canvas<BR>&nbsp;&nbsp;&nbsp;Desc=td(canvas(<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;handle:Canvas<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;glue:nswe<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;bg:white))<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<SPAN class="comment">%tdscrollbar:true<BR></SPAN>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<SPAN class="comment">%lrscrollbar:true))&nbsp;&nbsp;&nbsp;&nbsp;<BR></SPAN>&nbsp;&nbsp;&nbsp;Window={QTk<SPAN class="keyword">.</SPAN>build&nbsp;Desc}&nbsp;&nbsp;&nbsp;&nbsp;<BR>&nbsp;&nbsp;&nbsp;&nbsp;<BR>&nbsp;&nbsp;&nbsp;<SPAN class="comment">%%%%%%%&nbsp;Dictionary&nbsp;of&nbsp;pairs&nbsp;order&nbsp;store&nbsp;object,&nbsp;store&nbsp;object#graphic&nbsp;object<BR></SPAN>&nbsp;&nbsp;&nbsp;Dictobjects={NewDictionary&nbsp;$}<BR>&nbsp;&nbsp;&nbsp;NewObj&nbsp;LocalStore&nbsp;LS&nbsp;Movehere<BR>&nbsp;&nbsp;&nbsp;ListColors=&nbsp;[red&nbsp;green&nbsp;blue&nbsp;yellow]<BR>&nbsp;&nbsp;&nbsp;Colors={NewCell&nbsp;ListColors}<BR>&nbsp;&nbsp;&nbsp;<SPAN class="keyword">proc</SPAN>{<SPAN class="functionname">UpdateRectangle</SPAN>&nbsp;X&nbsp;Y&nbsp;Obj&nbsp;?Tag}&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Tag={Canvas&nbsp;newTag($)}&nbsp;&nbsp;<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{Canvas&nbsp;create(rectangle&nbsp;X<SPAN class="keyword">-</SPAN>50&nbsp;Y<SPAN class="keyword">-</SPAN>50&nbsp;X<SPAN class="keyword">+</SPAN>50&nbsp;Y<SPAN class="keyword">+</SPAN>50&nbsp;fill:{Obj&nbsp;getcolor($)}&nbsp;tags:Tag)}<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{Bindevent&nbsp;Tag&nbsp;Obj}&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<BR>&nbsp;&nbsp;&nbsp;<SPAN class="keyword">end</SPAN>&nbsp;<BR>&nbsp;&nbsp;&nbsp;<SPAN class="keyword">proc</SPAN>{<SPAN class="functionname">CreateRectangle</SPAN>&nbsp;X&nbsp;Y}<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Order&nbsp;Sobj&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Tag<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Col<BR>&nbsp;&nbsp;&nbsp;<SPAN class="keyword">in</SPAN>&nbsp;<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Tag={Canvas&nbsp;newTag($)}<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<SPAN class="keyword">case</SPAN>&nbsp;{Access&nbsp;Colors&nbsp;$}&nbsp;<SPAN class="keyword">of</SPAN>&nbsp;<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Color<SPAN class="keyword">|</SPAN>_&nbsp;<SPAN class="keyword">then</SPAN>&nbsp;Col=Color&nbsp;&nbsp;<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<SPAN class="keyword">[]</SPAN>&nbsp;nil&nbsp;<SPAN class="keyword">then</SPAN>&nbsp;{Assign&nbsp;Colors&nbsp;ListColors}&nbsp;Col=red<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<SPAN class="keyword">end</SPAN>&nbsp;&nbsp;&nbsp;&nbsp;<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{Assign&nbsp;Colors&nbsp;{List<SPAN class="keyword">.</SPAN>drop&nbsp;{Access&nbsp;Colors&nbsp;$}&nbsp;1&nbsp;$}}<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<SPAN class="keyword">try</SPAN>&nbsp;<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Sobj={NewObj&nbsp;&nbsp;Rectangle&nbsp;init(X&nbsp;Y&nbsp;&nbsp;Order&nbsp;Col)}<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{Canvas&nbsp;create(rectangle&nbsp;X<SPAN class="keyword">-</SPAN>50&nbsp;Y<SPAN class="keyword">-</SPAN>50&nbsp;X<SPAN class="keyword">+</SPAN>50&nbsp;Y<SPAN class="keyword">+</SPAN>50&nbsp;fill:Col&nbsp;tags:Tag)}<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{LocalStore&nbsp;getuniqueident(?Order)}&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{Dictionary<SPAN class="keyword">.</SPAN>put&nbsp;Dictobjects&nbsp;Order&nbsp;Sobj<SPAN class="keyword">#</SPAN>Tag}<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{Bindevent&nbsp;Tag&nbsp;Sobj}<BR>&nbsp;&nbsp;&nbsp;<SPAN class="keyword">catch</SPAN>&nbsp;gs(global_store_temporary_failed)&nbsp;<SPAN class="keyword">then</SPAN>&nbsp;<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{Show&nbsp;<SPAN class="string">'Object&nbsp;not&nbsp;created:&nbsp;retry'</SPAN>}<BR>&nbsp;&nbsp;&nbsp;<SPAN class="keyword">end</SPAN>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<BR>&nbsp;&nbsp;&nbsp;<SPAN class="keyword">end</SPAN>&nbsp;&nbsp;&nbsp;<BR>&nbsp;&nbsp;&nbsp;<SPAN class="keyword">proc</SPAN><SPAN class="variablename">&nbsp;</SPAN>{<SPAN class="functionname">Bindevent</SPAN>&nbsp;Tag&nbsp;&nbsp;Sobj}&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{Tag&nbsp;bind(event:<SPAN class="string">&quot;&lt;B1-ButtonRelease&gt;&quot;</SPAN>&nbsp;<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;args:[int(x)&nbsp;int(y)]<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;action:<SPAN class="keyword">proc</SPAN>{<SPAN class="functionname">$</SPAN>&nbsp;X&nbsp;Y}<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Out&nbsp;Transid<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<SPAN class="keyword">proc</SPAN><SPAN class="variablename">&nbsp;</SPAN>{<SPAN class="functionname">Trans</SPAN>&nbsp;Output}<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{Sobj&nbsp;setcoord(X&nbsp;Y)}<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<SPAN class="keyword">end</SPAN>&nbsp;<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<SPAN class="keyword">in</SPAN>&nbsp;<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{Tag&nbsp;setCoords(X<SPAN class="keyword">-</SPAN>50&nbsp;Y<SPAN class="keyword">-</SPAN>50&nbsp;X<SPAN class="keyword">+</SPAN>50&nbsp;Y<SPAN class="keyword">+</SPAN>50)}<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<SPAN class="comment">%&nbsp;initialise&nbsp;transaction&nbsp;on&nbsp;Tag<BR></SPAN>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{LocalStore&nbsp;trans(Trans&nbsp;Out&nbsp;Transid)}<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<SPAN class="comment">%{LocalStore&nbsp;checktrans(Transid&nbsp;Res&nbsp;_)}&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<BR></SPAN>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<SPAN class="keyword">end</SPAN>)}<BR>&nbsp;&nbsp;&nbsp;<SPAN class="keyword">end</SPAN>&nbsp;<BR>&nbsp;&nbsp;&nbsp;{Canvas&nbsp;bind(event:<SPAN class="string">&quot;&lt;2&gt;&quot;</SPAN>&nbsp;<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;args:[int(x)&nbsp;int(y)&nbsp;]<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;action:CreateRectangle)}<BR>&nbsp;&nbsp;&nbsp;&nbsp;<BR>&nbsp;&nbsp;RedrawAll<BR><SPAN class="keyword">in</SPAN>&nbsp;<BR>&nbsp;&nbsp;&nbsp;<SPAN class="comment">%%%%%%%%%%%%%%%%%%%%%%%%%<BR></SPAN>&nbsp;&nbsp;&nbsp;<SPAN class="comment">%%&nbsp;Initiate&nbsp;a&nbsp;local&nbsp;store<BR></SPAN>&nbsp;&nbsp;&nbsp;<SPAN class="comment">%%%%%%%%%%%%%%%%%%%%%%%%%<BR></SPAN>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<BR>&nbsp;&nbsp;&nbsp;<SPAN class="keyword">try</SPAN>&nbsp;LS={Connection<SPAN class="keyword">.</SPAN>take&nbsp;{Pickle<SPAN class="keyword">.</SPAN>load&nbsp;<SPAN class="string">'./client1ticket'</SPAN>&nbsp;$}}<BR>&nbsp;&nbsp;&nbsp;<SPAN class="keyword">catch</SPAN>&nbsp;<BR>&nbsp;&nbsp;&nbsp;&nbsp;error(url(_&nbsp;_)&nbsp;debug:_)&nbsp;<SPAN class="keyword">then</SPAN>&nbsp;{Show&nbsp;<SPAN class="string">'url&nbsp;or&nbsp;file&nbsp;not&nbsp;found'</SPAN>}<BR>&nbsp;&nbsp;&nbsp;<SPAN class="keyword">[]</SPAN>&nbsp;error(connection(_&nbsp;_)&nbsp;&nbsp;debug:_)&nbsp;&nbsp;<SPAN class="keyword">then</SPAN>&nbsp;{Show&nbsp;connectionfailed}<BR>&nbsp;&nbsp;&nbsp;<SPAN class="keyword">end</SPAN>&nbsp;&nbsp;&nbsp;&nbsp;<BR>&nbsp;&nbsp;&nbsp;&nbsp;<BR>&nbsp;&nbsp;&nbsp;<SPAN class="keyword">try</SPAN>&nbsp;<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{LS&nbsp;newlocal(Module&nbsp;user1&nbsp;&nbsp;?NewObj?LocalStore&nbsp;?Movehere)}<BR>&nbsp;&nbsp;&nbsp;<SPAN class="keyword">catch</SPAN>&nbsp;gs(connectionfailed)<BR>&nbsp;&nbsp;&nbsp;<SPAN class="keyword">then</SPAN>&nbsp;<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{Show&nbsp;connectionfailed}<BR>&nbsp;&nbsp;&nbsp;<SPAN class="keyword">end</SPAN>&nbsp;<BR>&nbsp;&nbsp;&nbsp;&nbsp;<BR>&nbsp;&nbsp;&nbsp;<BR>&nbsp;&nbsp;<SPAN class="comment">%&nbsp;set&nbsp;action&nbsp;when&nbsp;object&nbsp;creation<BR></SPAN>&nbsp;&nbsp;&nbsp;{LocalStore&nbsp;setnotifycreation(<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<SPAN class="keyword">proc</SPAN><SPAN class="variablename">&nbsp;</SPAN>{<SPAN class="functionname">$</SPAN>&nbsp;O}<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Tag&nbsp;X&nbsp;Y&nbsp;Ord&nbsp;<SPAN class="keyword">in</SPAN>&nbsp;<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{O&nbsp;getorder(Ord)}<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{Wait&nbsp;Ord}<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{O&nbsp;getcoord(X&nbsp;Y)}<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{UpdateRectangle&nbsp;X&nbsp;Y&nbsp;O&nbsp;?Tag}<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{Dictionary<SPAN class="keyword">.</SPAN>put&nbsp;&nbsp;Dictobjects&nbsp;Ord&nbsp;&nbsp;O<SPAN class="keyword">#</SPAN>Tag}<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<SPAN class="keyword">end</SPAN>)}<BR>&nbsp;&nbsp;&nbsp;<SPAN class="comment">%%%%&nbsp;Redraw&nbsp;All&nbsp;Objects<BR></SPAN>&nbsp;&nbsp;&nbsp;<SPAN class="keyword">proc</SPAN><SPAN class="variablename">&nbsp;</SPAN>{<SPAN class="functionname">RedrawAll</SPAN>}<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Entries&nbsp;En&nbsp;&nbsp;<SPAN class="keyword">in</SPAN>&nbsp;<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<SPAN class="comment">%&nbsp;sort&nbsp;Graphic&nbsp;objects<BR></SPAN>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{Dictionary<SPAN class="keyword">.</SPAN>keys&nbsp;Dictobjects&nbsp;?Entries}<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{List<SPAN class="keyword">.</SPAN>sort&nbsp;Entries&nbsp;Value<SPAN class="keyword">.</SPAN><SPAN class="string">'&lt;'</SPAN>&nbsp;?En}<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<SPAN class="comment">%&nbsp;redraw&nbsp;all&nbsp;objects&nbsp;in&nbsp;order<BR></SPAN>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{ForAll&nbsp;En<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<SPAN class="keyword">proc</SPAN><SPAN class="variablename">&nbsp;</SPAN>{<SPAN class="functionname">$</SPAN>&nbsp;Order}<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;O&nbsp;&nbsp;X&nbsp;Y&nbsp;Tag&nbsp;&nbsp;&nbsp;Go&nbsp;<SPAN class="keyword">in</SPAN>&nbsp;<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{Dictionary<SPAN class="keyword">.</SPAN>get&nbsp;Dictobjects&nbsp;Order&nbsp;&nbsp;O<SPAN class="keyword">#</SPAN>Go}<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{Go&nbsp;delete}<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{O&nbsp;getcoord(X&nbsp;Y)}<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{Go&nbsp;delete}<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{UpdateRectangle&nbsp;X&nbsp;Y&nbsp;O&nbsp;?Tag}<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{Dictionary<SPAN class="keyword">.</SPAN>remove&nbsp;Dictobjects&nbsp;Order}<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{Dictionary<SPAN class="keyword">.</SPAN>put&nbsp;Dictobjects&nbsp;Order&nbsp;O<SPAN class="keyword">#</SPAN>Tag}<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<SPAN class="keyword">end</SPAN>&nbsp;<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}<BR>&nbsp;&nbsp;&nbsp;&nbsp;<SPAN class="keyword">end</SPAN>&nbsp;<BR>&nbsp;&nbsp;&nbsp;&nbsp;<SPAN class="comment">%&nbsp;set&nbsp;action&nbsp;when&nbsp;receiving&nbsp;Obj&nbsp;object&nbsp;update<BR></SPAN>&nbsp;&nbsp;&nbsp;{LocalStore&nbsp;setnotifyupdate(<BR>&nbsp;&nbsp;&nbsp;&nbsp;<SPAN class="keyword">proc</SPAN><SPAN class="variablename">&nbsp;</SPAN>{<SPAN class="functionname">$</SPAN>&nbsp;?Obj}<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{RedrawAll}<BR>&nbsp;&nbsp;&nbsp;&nbsp;<SPAN class="keyword">end</SPAN>)<BR>&nbsp;&nbsp;&nbsp;}<BR>&nbsp;&nbsp;&nbsp;{LocalStore&nbsp;setnotifyabort(<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<SPAN class="keyword">proc</SPAN><SPAN class="variablename">&nbsp;</SPAN>{<SPAN class="functionname">$</SPAN>&nbsp;?Obj}<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{RedrawAll}<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<SPAN class="keyword">end</SPAN>&nbsp;<BR>&nbsp;&nbsp;&nbsp;&nbsp;)<BR>&nbsp;&nbsp;&nbsp;}<BR>&nbsp;&nbsp;&nbsp;{Window&nbsp;show(wait:<SPAN class="keyword">true</SPAN>)}<BR><SPAN class="keyword">end</SPAN>&nbsp;<BR></PRE></BLOCKQUOTE><P></P></DIV><DIV id="section.globalstore.fineg"><H2><A name="section.globalstore.fineg">5.2 Fine grained transactions</A></H2><P> This example illustrates the use of fine grained transactions to update object counters (see comments in the source code). First, we must create a new global store as it is described in the previous section. Then, we create two users connected to GS. </P><P> First user Program: </P><P class="margin"><A href="client1.oz">Source File</A></P><P> </P><BLOCKQUOTE><PRE><SPAN class="keyword">functor</SPAN>&nbsp;<BR><SPAN class="keyword">import</SPAN>&nbsp;<BR>&nbsp;&nbsp;&nbsp;System(show:Show)<BR>&nbsp;&nbsp;&nbsp;OS<BR>&nbsp;&nbsp;&nbsp;Open<BR>&nbsp;&nbsp;&nbsp;Pickle<BR>&nbsp;&nbsp;&nbsp;Connection<BR>&nbsp;&nbsp;&nbsp;Module<BR><SPAN class="keyword">define</SPAN>&nbsp;<BR>&nbsp;&nbsp;&nbsp;<SPAN class="comment">%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%<BR></SPAN>&nbsp;&nbsp;&nbsp;<SPAN class="comment">%%%&nbsp;Store&nbsp;emulator&nbsp;pid&nbsp;in&nbsp;a&nbsp;file<BR></SPAN>&nbsp;&nbsp;&nbsp;<SPAN class="comment">%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%<BR></SPAN>&nbsp;&nbsp;&nbsp;F&nbsp;Pid<BR>&nbsp;&nbsp;&nbsp;<SPAN class="keyword">try</SPAN>&nbsp;<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Pid={OS<SPAN class="keyword">.</SPAN>getPID}<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;F={New&nbsp;Open<SPAN class="keyword">.</SPAN>file&nbsp;init(name:<SPAN class="string">'/tmp/pidclient'</SPAN><SPAN class="keyword">#</SPAN>Pid&nbsp;flags:[write&nbsp;create])}&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{F&nbsp;write(vs:Pid)}<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{F&nbsp;close}<BR>&nbsp;&nbsp;&nbsp;<SPAN class="keyword">catch</SPAN>&nbsp;<BR>&nbsp;&nbsp;&nbsp;error(_)<BR>&nbsp;&nbsp;&nbsp;<SPAN class="keyword">then</SPAN>&nbsp;<BR>&nbsp;&nbsp;&nbsp;{Show&nbsp;<SPAN class="string">'ErrorCreateFile'</SPAN>}<BR>&nbsp;&nbsp;&nbsp;<SPAN class="keyword">end</SPAN>&nbsp;<BR>&nbsp;&nbsp;&nbsp;<SPAN class="comment">%%%%%%%%%%%%%%%%%%%%%%%%%<BR></SPAN>&nbsp;&nbsp;&nbsp;<SPAN class="comment">%%&nbsp;Connect&nbsp;to&nbsp;GS<BR></SPAN>&nbsp;&nbsp;&nbsp;<SPAN class="comment">%%%%%%%%%%%%%%%%%%%%%%%%%&nbsp;&nbsp;&nbsp;<BR></SPAN>&nbsp;&nbsp;&nbsp;LS<BR>&nbsp;&nbsp;&nbsp;<SPAN class="keyword">try</SPAN>&nbsp;LS={Connection<SPAN class="keyword">.</SPAN>take&nbsp;{Pickle<SPAN class="keyword">.</SPAN>load&nbsp;<SPAN class="string">'./gsticket'</SPAN>&nbsp;$}}<BR>&nbsp;&nbsp;&nbsp;<SPAN class="keyword">catch</SPAN>&nbsp;<BR>&nbsp;&nbsp;&nbsp;&nbsp;error(url(_&nbsp;_)&nbsp;debug:_)&nbsp;<SPAN class="keyword">then</SPAN>&nbsp;{Show&nbsp;<SPAN class="string">'url&nbsp;or&nbsp;file&nbsp;not&nbsp;found'</SPAN>}<BR>&nbsp;&nbsp;&nbsp;<SPAN class="keyword">[]</SPAN>&nbsp;error(connection(_&nbsp;_)&nbsp;&nbsp;debug:_)&nbsp;&nbsp;<SPAN class="keyword">then</SPAN>&nbsp;{Show&nbsp;connectionfailed}<BR>&nbsp;&nbsp;&nbsp;<SPAN class="keyword">end</SPAN>&nbsp;<BR>&nbsp;&nbsp;&nbsp;NewObj&nbsp;LocalStore&nbsp;Movehere<BR>&nbsp;&nbsp;&nbsp;<SPAN class="keyword">try</SPAN>&nbsp;<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{LS&nbsp;newLocal(Module&nbsp;user1&nbsp;&nbsp;?NewObj&nbsp;?LocalStore&nbsp;?Movehere)}<BR>&nbsp;&nbsp;&nbsp;<SPAN class="keyword">catch</SPAN>&nbsp;gs(connectionfailed)<BR>&nbsp;&nbsp;&nbsp;<SPAN class="keyword">then</SPAN>&nbsp;<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{Show&nbsp;connectionfailed}<BR>&nbsp;&nbsp;&nbsp;<SPAN class="keyword">end</SPAN>&nbsp;<BR>&nbsp;&nbsp;&nbsp;<SPAN class="keyword">try</SPAN>&nbsp;{Pickle<SPAN class="keyword">.</SPAN>save&nbsp;{Connection<SPAN class="keyword">.</SPAN>offerUnlimited&nbsp;LocalStore&nbsp;$}&nbsp;<SPAN class="string">'./client1ticket'</SPAN>}<BR>&nbsp;&nbsp;&nbsp;<SPAN class="keyword">catch</SPAN>&nbsp;<BR>&nbsp;&nbsp;&nbsp;&nbsp;error(url(_&nbsp;_)&nbsp;debug:_)&nbsp;<SPAN class="keyword">then</SPAN>&nbsp;{Show&nbsp;<SPAN class="string">'cannot&nbsp;create&nbsp;url&nbsp;or&nbsp;file&nbsp;'</SPAN>}<BR>&nbsp;&nbsp;&nbsp;<SPAN class="keyword">[]</SPAN>&nbsp;error(connection(_&nbsp;_)&nbsp;&nbsp;debug:_)&nbsp;&nbsp;<SPAN class="keyword">then</SPAN>&nbsp;{Show&nbsp;<SPAN class="string">'connection&nbsp;Module&nbsp;error'</SPAN>}<BR>&nbsp;&nbsp;&nbsp;<SPAN class="keyword">end</SPAN>&nbsp;<BR>&nbsp;&nbsp;&nbsp;<SPAN class="comment">%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%<BR></SPAN>&nbsp;&nbsp;&nbsp;<SPAN class="comment">%%&nbsp;Create&nbsp;objects&nbsp;in&nbsp;the&nbsp;store:<BR></SPAN>&nbsp;&nbsp;&nbsp;<SPAN class="comment">%&nbsp;&nbsp;Obj1&nbsp;Obj2&nbsp;Obj3&nbsp;are&nbsp;references&nbsp;in<BR></SPAN>&nbsp;&nbsp;&nbsp;<SPAN class="comment">%&nbsp;&nbsp;the&nbsp;LocalStore&nbsp;&nbsp;<BR></SPAN>&nbsp;&nbsp;&nbsp;<SPAN class="comment">%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%&nbsp;&nbsp;&nbsp;&nbsp;<BR></SPAN>&nbsp;&nbsp;&nbsp;<SPAN class="keyword">class</SPAN>&nbsp;<SPAN class="type">Counter</SPAN>&nbsp;<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<SPAN class="keyword">attr</SPAN>&nbsp;val<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<SPAN class="keyword">meth</SPAN>&nbsp;<SPAN class="functionname">show</SPAN>(Value)&nbsp;Value=<SPAN class="keyword">@</SPAN>val&nbsp;<SPAN class="keyword">end</SPAN>&nbsp;<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<SPAN class="keyword">meth</SPAN>&nbsp;<SPAN class="functionname">inc</SPAN>(Value)<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;val&nbsp;<SPAN class="keyword">&lt;-</SPAN>&nbsp;<SPAN class="keyword">@</SPAN>val<SPAN class="keyword">+</SPAN>Value<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<SPAN class="comment">%{Obj3&nbsp;dec(1)}<BR></SPAN>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<SPAN class="keyword">end</SPAN>&nbsp;<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<SPAN class="keyword">meth</SPAN>&nbsp;<SPAN class="functionname">dec</SPAN>(Value)<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;val&nbsp;<SPAN class="keyword">&lt;-</SPAN>&nbsp;<SPAN class="keyword">@</SPAN>val<SPAN class="keyword">-</SPAN>Value&nbsp;&nbsp;<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<SPAN class="keyword">end</SPAN>&nbsp;<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<SPAN class="keyword">meth</SPAN>&nbsp;<SPAN class="functionname">init</SPAN>(Value)&nbsp;val&nbsp;<SPAN class="keyword">&lt;-</SPAN>&nbsp;Value&nbsp;<SPAN class="keyword">end</SPAN>&nbsp;&nbsp;&nbsp;<BR>&nbsp;&nbsp;&nbsp;<SPAN class="keyword">end</SPAN>&nbsp;<BR>&nbsp;&nbsp;&nbsp;&nbsp;<BR>&nbsp;&nbsp;&nbsp;Obj1={NewObj&nbsp;&nbsp;Counter&nbsp;init(0)}<BR>&nbsp;&nbsp;&nbsp;Obj2={NewObj&nbsp;&nbsp;Counter&nbsp;&nbsp;init(0)}<BR>&nbsp;&nbsp;&nbsp;Obj3={NewObj&nbsp;&nbsp;Counter&nbsp;&nbsp;init(0)}<BR>&nbsp;&nbsp;&nbsp;<SPAN class="comment">%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%<BR></SPAN>&nbsp;&nbsp;&nbsp;<SPAN class="comment">%%&nbsp;Save&nbsp;&nbsp;Obj1&nbsp;reference&nbsp;to&nbsp;use&nbsp;it&nbsp;on&nbsp;other&nbsp;clients<BR></SPAN>&nbsp;&nbsp;&nbsp;<SPAN class="comment">%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%<BR></SPAN>&nbsp;&nbsp;&nbsp;<SPAN class="keyword">try</SPAN>&nbsp;{LocalStore&nbsp;saveobj(Obj1&nbsp;<SPAN class="string">'/usr/staff/ila/=Oz/store/o1globalref'</SPAN>)}<BR>&nbsp;&nbsp;&nbsp;<SPAN class="keyword">catch</SPAN>&nbsp;<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;gs(use_localstore_localreference)&nbsp;<SPAN class="keyword">then</SPAN>&nbsp;{Show&nbsp;<SPAN class="string">'cannot&nbsp;apply&nbsp;methods&nbsp;on&nbsp;remote&nbsp;clients'</SPAN>}<BR>&nbsp;&nbsp;&nbsp;<SPAN class="keyword">[]</SPAN>&nbsp;error(url(_&nbsp;_)&nbsp;debug:_)&nbsp;<SPAN class="keyword">then</SPAN>&nbsp;{Show&nbsp;<SPAN class="string">'cannot&nbsp;create&nbsp;url&nbsp;or&nbsp;file&nbsp;'</SPAN>}<BR>&nbsp;&nbsp;&nbsp;<SPAN class="keyword">[]</SPAN>&nbsp;error(connection(_&nbsp;_)&nbsp;&nbsp;debug:_)&nbsp;&nbsp;<SPAN class="keyword">then</SPAN>&nbsp;{Show&nbsp;<SPAN class="string">'connection&nbsp;Module&nbsp;error'</SPAN>}<BR>&nbsp;&nbsp;&nbsp;<SPAN class="keyword">end</SPAN>&nbsp;<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<BR>&nbsp;&nbsp;&nbsp;<SPAN class="comment">%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%<BR></SPAN>&nbsp;&nbsp;&nbsp;<SPAN class="comment">%&nbsp;Procedure&nbsp;to&nbsp;show&nbsp;a&nbsp;coherent<BR></SPAN>&nbsp;&nbsp;&nbsp;<SPAN class="comment">%&nbsp;snapshot&nbsp;of&nbsp;the&nbsp;global&nbsp;store<BR></SPAN>&nbsp;&nbsp;&nbsp;<SPAN class="comment">%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%<BR></SPAN>&nbsp;&nbsp;&nbsp;<SPAN class="keyword">proc</SPAN><SPAN class="variablename">&nbsp;</SPAN>{<SPAN class="functionname">CoherentSnapshot</SPAN>}<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;C={NewCell&nbsp;0}&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<SPAN class="keyword">proc</SPAN>{<SPAN class="functionname">Trans</SPAN>&nbsp;Output}<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Val1&nbsp;Val2&nbsp;Val3&nbsp;<SPAN class="keyword">in</SPAN>&nbsp;<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{Obj1&nbsp;show(Val1)}&nbsp;&nbsp;<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{Obj2&nbsp;show(Val2)}<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{Obj3&nbsp;show(Val3)}<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Output=state(Val1&nbsp;Val2&nbsp;Val3)<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<SPAN class="keyword">end</SPAN>&nbsp;<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Trid<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Out<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Res<BR>&nbsp;&nbsp;&nbsp;&nbsp;<SPAN class="keyword">in</SPAN>&nbsp;<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<SPAN class="comment">%&nbsp;State&nbsp;of&nbsp;objects&nbsp;Obj1&nbsp;Obj2&nbsp;is&nbsp;coherent&nbsp;here<BR></SPAN>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<SPAN class="comment">%&nbsp;show&nbsp;&nbsp;state&nbsp;of&nbsp;&nbsp;objects&nbsp;in&nbsp;a&nbsp;file&nbsp;after&nbsp;1mn&nbsp;of&nbsp;period<BR></SPAN>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<SPAN class="keyword">if</SPAN>&nbsp;{OS<SPAN class="keyword">.</SPAN>time&nbsp;&nbsp;$}&nbsp;<SPAN class="keyword">-</SPAN>&nbsp;{Access&nbsp;C&nbsp;$}<SPAN class="keyword">&gt;=</SPAN>20<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<SPAN class="keyword">then</SPAN>&nbsp;<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<SPAN class="comment">%Localstore&nbsp;may&nbsp;raise&nbsp;the&nbsp;&nbsp;exception:<BR></SPAN>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<SPAN class="comment">%&nbsp;&nbsp;&nbsp;gs(use_localstore_localreference)<BR></SPAN>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<SPAN class="comment">%&nbsp;&nbsp;&nbsp;gs(undefinedmethod#Meth)<BR></SPAN>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<SPAN class="comment">%&nbsp;&nbsp;&nbsp;gs(invalidcall)&nbsp;%&nbsp;for&nbsp;waitlocks,&nbsp;retrans,&nbsp;newthread,&nbsp;{O&nbsp;M}<BR></SPAN>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{LocalStore&nbsp;trans(Trans&nbsp;Out&nbsp;?Trid)}&nbsp;&nbsp;<SPAN class="comment">%&nbsp;raise&nbsp;gs(ill_formed_transaction)<BR></SPAN>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{LocalStore&nbsp;checktrans(Trid&nbsp;Res&nbsp;_)}&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<SPAN class="keyword">if</SPAN>&nbsp;Res<SPAN class="keyword">==</SPAN>commit&nbsp;&nbsp;<SPAN class="keyword">then</SPAN>&nbsp;<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{Show&nbsp;<SPAN class="string">'Obj1:'</SPAN><SPAN class="keyword">#</SPAN>Out<SPAN class="keyword">.</SPAN>1<SPAN class="keyword">#</SPAN><SPAN class="string">'Obj2:'</SPAN><SPAN class="keyword">#</SPAN>Out<SPAN class="keyword">.</SPAN>2<SPAN class="keyword">#</SPAN><SPAN class="string">'Obj3:'</SPAN><SPAN class="keyword">#</SPAN>Out<SPAN class="keyword">.</SPAN>3}<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<SPAN class="keyword">else</SPAN>&nbsp;<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<SPAN class="keyword">skip</SPAN>&nbsp;<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<SPAN class="keyword">end</SPAN>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{Assign&nbsp;C&nbsp;{OS<SPAN class="keyword">.</SPAN>time&nbsp;&nbsp;$}}<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<SPAN class="keyword">else</SPAN>&nbsp;<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<SPAN class="keyword">skip</SPAN>&nbsp;<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<SPAN class="keyword">end</SPAN>&nbsp;<BR>&nbsp;&nbsp;&nbsp;<SPAN class="keyword">end</SPAN>&nbsp;&nbsp;&nbsp;&nbsp;<BR>&nbsp;&nbsp;&nbsp;<SPAN class="comment">%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%<BR></SPAN>&nbsp;&nbsp;&nbsp;<SPAN class="comment">%&nbsp;Initialise&nbsp;transactions<BR></SPAN>&nbsp;&nbsp;&nbsp;<SPAN class="comment">%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%<BR></SPAN>&nbsp;&nbsp;&nbsp;LastTransid<BR>&nbsp;&nbsp;&nbsp;<SPAN class="keyword">fun</SPAN><SPAN class="variablename">&nbsp;</SPAN>{<SPAN class="functionname">Iterate</SPAN>&nbsp;I}<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Transid&nbsp;&nbsp;Retransid&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<SPAN class="keyword">proc</SPAN>{<SPAN class="functionname">Trans</SPAN>&nbsp;Out}<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<SPAN class="keyword">proc</SPAN><SPAN class="variablename">&nbsp;</SPAN>{<SPAN class="functionname">Iteratebis</SPAN>&nbsp;J}&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<SPAN class="keyword">if</SPAN>&nbsp;J<SPAN class="keyword">\=</SPAN>0<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<SPAN class="keyword">then</SPAN>&nbsp;<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<SPAN class="comment">%{LocalStore&nbsp;waitlocks([Obj1&nbsp;Obj2])}&nbsp;&nbsp;&nbsp;<BR></SPAN>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{Obj1&nbsp;inc(1)}<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{Obj1&nbsp;inc(<SPAN class="keyword">~</SPAN>1)}<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<SPAN class="comment">%{LocalStore&nbsp;newthread(proc&nbsp;{$}&nbsp;{Show&nbsp;'newthread'}&nbsp;{Obj1&nbsp;inc(1)}&nbsp;end)}<BR></SPAN>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<SPAN class="comment">%if&nbsp;{IsEven&nbsp;{Obj1&nbsp;show($)}}==true<BR></SPAN>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<SPAN class="comment">%&nbsp;&nbsp;then&nbsp;&nbsp;<BR></SPAN>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{Obj2&nbsp;inc(<SPAN class="keyword">~</SPAN>1)}&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{Obj2&nbsp;inc(2)}<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<SPAN class="comment">%&nbsp;else<BR></SPAN>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<SPAN class="comment">%&nbsp;&nbsp;skip<BR></SPAN>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<SPAN class="comment">%end&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<BR></SPAN>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{Obj1&nbsp;inc(1)}<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{Obj1&nbsp;inc(<SPAN class="keyword">~</SPAN>1)}<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{Obj1&nbsp;inc(1)}<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{Obj1&nbsp;inc(<SPAN class="keyword">~</SPAN>1)}<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{Obj1&nbsp;inc(1)}<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<SPAN class="comment">%{LocalStore&nbsp;waitlocks([Obj3&nbsp;Obj1])}&nbsp;&nbsp;<BR></SPAN>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{Obj3&nbsp;inc(1)}<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{Iteratebis&nbsp;J<SPAN class="keyword">-</SPAN>1}<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<SPAN class="keyword">else</SPAN>&nbsp;<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<SPAN class="keyword">skip</SPAN>&nbsp;<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<SPAN class="keyword">end</SPAN>&nbsp;<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<SPAN class="keyword">end</SPAN>&nbsp;<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;OutPut<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<SPAN class="keyword">in</SPAN>&nbsp;<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{Iteratebis&nbsp;1}<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<SPAN class="comment">%&nbsp;&nbsp;{LocalStore&nbsp;retrans(<BR>%&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;proc&nbsp;{$&nbsp;Out}<BR>%&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{Obj1&nbsp;inc(1)}<BR>%&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{Obj3&nbsp;inc(1)}&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<BR>%&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;end<BR>%&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;OutPut<BR>%&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;?Retransid)<BR>%&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}<BR></SPAN>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<SPAN class="keyword">end</SPAN>&nbsp;<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Out<BR>&nbsp;&nbsp;&nbsp;<SPAN class="keyword">in</SPAN>&nbsp;<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<SPAN class="keyword">if</SPAN>&nbsp;I<SPAN class="keyword">\=</SPAN>0<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<SPAN class="keyword">then</SPAN>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{LocalStore&nbsp;trans(Trans&nbsp;Out&nbsp;?Transid)}<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<SPAN class="comment">%{Delay&nbsp;1}<BR></SPAN>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<SPAN class="keyword">if</SPAN>&nbsp;I<SPAN class="keyword">==</SPAN>1&nbsp;<SPAN class="keyword">then</SPAN>&nbsp;<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;LastTransid=Transid&nbsp;&nbsp;<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<SPAN class="comment">%LastTransid=Retransid<BR></SPAN>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<SPAN class="keyword">else</SPAN>&nbsp;<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<SPAN class="keyword">skip</SPAN>&nbsp;<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<SPAN class="keyword">end</SPAN>&nbsp;<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(Transid<SPAN class="keyword">#</SPAN>Transid)<SPAN class="keyword">|</SPAN>{Iterate&nbsp;I<SPAN class="keyword">-</SPAN>1}<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<SPAN class="comment">%(Transid#Retransid)|{Iterate&nbsp;I-1}<BR></SPAN>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<SPAN class="keyword">else</SPAN>&nbsp;<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;nil<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<SPAN class="keyword">end</SPAN>&nbsp;<BR>&nbsp;&nbsp;&nbsp;<SPAN class="keyword">end</SPAN>&nbsp;<BR>&nbsp;&nbsp;&nbsp;&nbsp;<BR>&nbsp;&nbsp;&nbsp;<SPAN class="comment">%%%%%%%%%%%%%%%%%%%%%%%%%%%%<BR></SPAN>&nbsp;&nbsp;&nbsp;<SPAN class="comment">%%&nbsp;Migrate&nbsp;the&nbsp;global&nbsp;store<BR></SPAN>&nbsp;&nbsp;&nbsp;<SPAN class="comment">%%%%%%%%%%%%%%%%%%%%%%%%%%%%<BR></SPAN>&nbsp;&nbsp;&nbsp;<SPAN class="comment">%thread<BR></SPAN>&nbsp;&nbsp;&nbsp;<SPAN class="comment">%&nbsp;&nbsp;&nbsp;{Delay&nbsp;15000}<BR></SPAN>&nbsp;&nbsp;&nbsp;<SPAN class="comment">%&nbsp;&nbsp;&nbsp;{Movehere&nbsp;Module&nbsp;_&nbsp;proc{$}&nbsp;skip&nbsp;end&nbsp;}<BR></SPAN>&nbsp;&nbsp;&nbsp;<SPAN class="comment">%end<BR></SPAN>&nbsp;&nbsp;&nbsp;&nbsp;<BR>&nbsp;&nbsp;&nbsp;Transset={Iterate&nbsp;2000}<BR>&nbsp;&nbsp;&nbsp;<BR>&nbsp;&nbsp;&nbsp;<SPAN class="comment">%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%<BR></SPAN>&nbsp;&nbsp;&nbsp;<SPAN class="comment">%%&nbsp;Wait&nbsp;for&nbsp;the&nbsp;end&nbsp;of&nbsp;transactions&nbsp;and&nbsp;updates&nbsp;&nbsp;<BR></SPAN>&nbsp;&nbsp;&nbsp;<SPAN class="comment">%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%<BR></SPAN>&nbsp;&nbsp;&nbsp;<SPAN class="comment">%{Wait&nbsp;{LocalStore&nbsp;checktrans(LastTransid&nbsp;$&nbsp;_)}}&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;%&nbsp;For&nbsp;transactions&nbsp;&nbsp;<BR></SPAN>&nbsp;&nbsp;&nbsp;{Wait&nbsp;{LocalStore&nbsp;termination($)}}&nbsp;<SPAN class="comment">%&nbsp;For&nbsp;updates<BR></SPAN>&nbsp;&nbsp;&nbsp;<SPAN class="comment">%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%<BR></SPAN>&nbsp;&nbsp;&nbsp;<SPAN class="comment">%%&nbsp;Compute&nbsp;number&nbsp;of&nbsp;committed/aborted&nbsp;transactions<BR></SPAN>&nbsp;&nbsp;&nbsp;<SPAN class="comment">%%&nbsp;Compute&nbsp;number&nbsp;of&nbsp;committed/aborted&nbsp;retransactions<BR></SPAN>&nbsp;&nbsp;&nbsp;<SPAN class="comment">%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%<BR></SPAN>&nbsp;&nbsp;&nbsp;Ccommit={NewCell&nbsp;0}&nbsp;Cabort={NewCell&nbsp;0}<BR>&nbsp;&nbsp;&nbsp;Crcommit={NewCell&nbsp;0}&nbsp;Crabort={NewCell&nbsp;0}<BR>&nbsp;&nbsp;&nbsp;Crecompute={NewCell&nbsp;0}&nbsp;Crrecompute={NewCell&nbsp;0}<BR>&nbsp;&nbsp;&nbsp;{ForAll&nbsp;Transset&nbsp;&nbsp;<BR>&nbsp;&nbsp;&nbsp;&nbsp;<SPAN class="keyword">proc</SPAN>{<SPAN class="functionname">$</SPAN>&nbsp;Pair}<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Tr&nbsp;RTr&nbsp;Res&nbsp;Resb&nbsp;Nb&nbsp;Nbr&nbsp;<SPAN class="keyword">in</SPAN>&nbsp;<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<SPAN class="keyword">if</SPAN>&nbsp;Pair<SPAN class="keyword">\=</SPAN>nil&nbsp;<SPAN class="keyword">then</SPAN>&nbsp;<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Pair=Tr<SPAN class="keyword">#</SPAN>RTr<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{LocalStore&nbsp;checktrans(Tr&nbsp;?Res&nbsp;?Nb)}<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{Assign&nbsp;Crecompute&nbsp;&nbsp;{Access&nbsp;Crecompute&nbsp;&nbsp;$}<SPAN class="keyword">+</SPAN>Nb}&nbsp;&nbsp;&nbsp;<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<SPAN class="keyword">if</SPAN>&nbsp;&nbsp;Res<SPAN class="keyword">==</SPAN>commit<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<SPAN class="keyword">then</SPAN>&nbsp;<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{Assign&nbsp;Ccommit&nbsp;{Access&nbsp;Ccommit&nbsp;&nbsp;$}<SPAN class="keyword">+</SPAN>1}<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<SPAN class="keyword">else</SPAN>&nbsp;<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{Assign&nbsp;Cabort&nbsp;{Access&nbsp;Cabort&nbsp;$}<SPAN class="keyword">+</SPAN>1}<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<SPAN class="keyword">end</SPAN>&nbsp;<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<SPAN class="keyword">if</SPAN>&nbsp;{Access&nbsp;Ccommit&nbsp;&nbsp;$}<SPAN class="keyword">+</SPAN>{Access&nbsp;Cabort&nbsp;&nbsp;$}<SPAN class="keyword">==</SPAN>2000&nbsp;<SPAN class="keyword">then</SPAN>&nbsp;<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{Show&nbsp;<SPAN class="string">'Number&nbsp;of&nbsp;local&nbsp;committed&nbsp;transaction:'</SPAN><SPAN class="keyword">#</SPAN>{Access&nbsp;Ccommit&nbsp;&nbsp;$}}<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{Show&nbsp;<SPAN class="string">'Number&nbsp;of&nbsp;local&nbsp;aborted&nbsp;transaction:'</SPAN><SPAN class="keyword">#</SPAN>{Access&nbsp;Cabort&nbsp;&nbsp;$}}<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{Show&nbsp;<SPAN class="string">'Number&nbsp;of&nbsp;local&nbsp;recomputed&nbsp;transaction:'</SPAN><SPAN class="keyword">#</SPAN>{Access&nbsp;Crecompute&nbsp;&nbsp;$}}<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<SPAN class="keyword">else</SPAN>&nbsp;<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<SPAN class="keyword">skip</SPAN>&nbsp;<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<SPAN class="keyword">end</SPAN>&nbsp;<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<SPAN class="keyword">if</SPAN>&nbsp;{IsFree&nbsp;RTr}&nbsp;<SPAN class="keyword">then</SPAN>&nbsp;<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Resb=abort&nbsp;<SPAN class="comment">%&nbsp;Thread&nbsp;terminated&nbsp;before&nbsp;executing&nbsp;retrans<BR></SPAN>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Nbr=0<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<SPAN class="keyword">else</SPAN>&nbsp;<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{LocalStore&nbsp;checktrans(RTr&nbsp;Resb&nbsp;Nbr)}<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<SPAN class="keyword">end</SPAN>&nbsp;<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{Assign&nbsp;Crrecompute&nbsp;&nbsp;{Access&nbsp;Crrecompute&nbsp;&nbsp;$}<SPAN class="keyword">+</SPAN>Nbr}&nbsp;&nbsp;<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<SPAN class="keyword">if</SPAN>&nbsp;Resb<SPAN class="keyword">==</SPAN>commit<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<SPAN class="keyword">then</SPAN>&nbsp;<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{Assign&nbsp;Crcommit&nbsp;{Access&nbsp;Crcommit&nbsp;&nbsp;$}<SPAN class="keyword">+</SPAN>1}<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<SPAN class="keyword">else</SPAN>&nbsp;<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{Assign&nbsp;Crabort&nbsp;{Access&nbsp;Crabort&nbsp;$}<SPAN class="keyword">+</SPAN>1}<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<SPAN class="keyword">end</SPAN>&nbsp;<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<SPAN class="keyword">if</SPAN>&nbsp;{Access&nbsp;Crcommit&nbsp;&nbsp;$}<SPAN class="keyword">+</SPAN>{Access&nbsp;Crabort&nbsp;&nbsp;$}<SPAN class="keyword">==</SPAN>2000&nbsp;<SPAN class="keyword">then</SPAN>&nbsp;<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{Show&nbsp;<SPAN class="string">'Number&nbsp;of&nbsp;local&nbsp;aborted&nbsp;retrans:'</SPAN><SPAN class="keyword">#</SPAN>{Access&nbsp;Crabort&nbsp;&nbsp;$}}<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{Show&nbsp;<SPAN class="string">'Number&nbsp;of&nbsp;local&nbsp;committed&nbsp;retrans&nbsp;:'</SPAN><SPAN class="keyword">#</SPAN>{Access&nbsp;Crcommit&nbsp;&nbsp;$}}<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{Show&nbsp;<SPAN class="string">'Number&nbsp;of&nbsp;local&nbsp;recomputed&nbsp;retrans:'</SPAN><SPAN class="keyword">#</SPAN>{Access&nbsp;Crrecompute&nbsp;&nbsp;$}}<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<SPAN class="keyword">else</SPAN>&nbsp;<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<SPAN class="keyword">skip</SPAN>&nbsp;<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<SPAN class="keyword">end</SPAN>&nbsp;<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<SPAN class="keyword">else</SPAN>&nbsp;<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<SPAN class="keyword">skip</SPAN>&nbsp;<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<SPAN class="keyword">end</SPAN>&nbsp;<BR>&nbsp;&nbsp;&nbsp;&nbsp;<SPAN class="keyword">end</SPAN>&nbsp;<BR>&nbsp;&nbsp;&nbsp;}&nbsp;&nbsp;&nbsp;<BR>&nbsp;&nbsp;&nbsp;<SPAN class="comment">%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%<BR></SPAN>&nbsp;&nbsp;&nbsp;<SPAN class="comment">%%&nbsp;Show&nbsp;states&nbsp;of&nbsp;objects<BR></SPAN>&nbsp;&nbsp;&nbsp;<SPAN class="comment">%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%&nbsp;&nbsp;&nbsp;<BR></SPAN>&nbsp;&nbsp;&nbsp;{CoherentSnapshot}<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<BR><SPAN class="keyword">end</SPAN>&nbsp;<BR></PRE></BLOCKQUOTE><P></P><P> Second user Program: </P><P class="margin"><A href="client2.oz">Source File</A></P><P> </P><BLOCKQUOTE><PRE><SPAN class="keyword">functor</SPAN>&nbsp;<BR><SPAN class="keyword">import</SPAN>&nbsp;<BR>&nbsp;&nbsp;&nbsp;System(show:Show)&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<BR>&nbsp;&nbsp;&nbsp;OS<BR>&nbsp;&nbsp;&nbsp;Open<BR>&nbsp;&nbsp;&nbsp;Connection<BR>&nbsp;&nbsp;&nbsp;Pickle<BR>&nbsp;&nbsp;&nbsp;Module<BR>&nbsp;&nbsp;&nbsp;Application<BR><SPAN class="keyword">define</SPAN>&nbsp;&nbsp;<BR>&nbsp;&nbsp;&nbsp;<SPAN class="keyword">class</SPAN>&nbsp;<SPAN class="type">Counter</SPAN>&nbsp;<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<SPAN class="keyword">attr</SPAN>&nbsp;val<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<SPAN class="keyword">meth</SPAN>&nbsp;<SPAN class="functionname">show</SPAN>(Value)&nbsp;Value=<SPAN class="keyword">@</SPAN>val&nbsp;<SPAN class="keyword">end</SPAN>&nbsp;<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<SPAN class="keyword">meth</SPAN>&nbsp;<SPAN class="functionname">inc</SPAN>(Value)&nbsp;val&nbsp;<SPAN class="keyword">&lt;-</SPAN>&nbsp;<SPAN class="keyword">@</SPAN>val<SPAN class="keyword">+</SPAN>Value&nbsp;<SPAN class="keyword">end</SPAN>&nbsp;<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<SPAN class="keyword">meth</SPAN>&nbsp;<SPAN class="functionname">init</SPAN>(Value)&nbsp;val&nbsp;<SPAN class="keyword">&lt;-</SPAN>&nbsp;Value&nbsp;<SPAN class="keyword">end</SPAN>&nbsp;&nbsp;&nbsp;<BR>&nbsp;&nbsp;&nbsp;<SPAN class="keyword">end</SPAN>&nbsp;<BR>&nbsp;&nbsp;&nbsp;<SPAN class="comment">%%%&nbsp;Store&nbsp;emulator&nbsp;pid&nbsp;in&nbsp;a&nbsp;file<BR></SPAN>&nbsp;&nbsp;&nbsp;F&nbsp;Pid&nbsp;&nbsp;<BR>&nbsp;&nbsp;&nbsp;<SPAN class="keyword">try</SPAN>&nbsp;<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Pid={OS<SPAN class="keyword">.</SPAN>getPID}<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;F={New&nbsp;Open<SPAN class="keyword">.</SPAN>file&nbsp;init(name:<SPAN class="string">'/tmp/pidclient'</SPAN><SPAN class="keyword">#</SPAN>Pid&nbsp;flags:[write&nbsp;create])}&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{F&nbsp;write(vs:Pid)}<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{F&nbsp;close}<BR>&nbsp;&nbsp;&nbsp;<SPAN class="keyword">catch</SPAN>&nbsp;<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;error(_)<BR>&nbsp;&nbsp;&nbsp;<SPAN class="keyword">then</SPAN>&nbsp;<BR>&nbsp;&nbsp;&nbsp;{Show&nbsp;<SPAN class="string">'ErrorCreateFile'</SPAN>}<BR>&nbsp;&nbsp;&nbsp;<SPAN class="keyword">end</SPAN>&nbsp;&nbsp;&nbsp;&nbsp;<BR>&nbsp;&nbsp;&nbsp;<SPAN class="comment">%%%&nbsp;deamon&nbsp;to&nbsp;simulate&nbsp;site&nbsp;failure<BR></SPAN>&nbsp;&nbsp;&nbsp;<SPAN class="comment">%{OS.system&nbsp;&quot;deamon&quot;&nbsp;_}<BR></SPAN>&nbsp;&nbsp;&nbsp;<SPAN class="comment">%%%<BR></SPAN>&nbsp;&nbsp;&nbsp;<SPAN class="comment">%%%%%%%%%%%%%%%%%%%%%%%%%<BR></SPAN>&nbsp;&nbsp;&nbsp;<SPAN class="comment">%%&nbsp;Initiate&nbsp;a&nbsp;local&nbsp;store<BR></SPAN>&nbsp;&nbsp;&nbsp;<SPAN class="comment">%%%%%%%%%%%%%%%%%%%%%%%%%<BR></SPAN>&nbsp;&nbsp;&nbsp;&nbsp;LS<BR>&nbsp;&nbsp;&nbsp;<SPAN class="keyword">try</SPAN>&nbsp;LS={Connection<SPAN class="keyword">.</SPAN>take&nbsp;{Pickle<SPAN class="keyword">.</SPAN>load&nbsp;<SPAN class="string">'./client1ticket'</SPAN>&nbsp;$}}<BR>&nbsp;&nbsp;&nbsp;<SPAN class="keyword">catch</SPAN>&nbsp;<BR>&nbsp;&nbsp;&nbsp;&nbsp;error(url(_&nbsp;_)&nbsp;debug:_)&nbsp;<SPAN class="keyword">then</SPAN>&nbsp;{Show&nbsp;<SPAN class="string">'url&nbsp;or&nbsp;file&nbsp;not&nbsp;found'</SPAN>}<BR>&nbsp;&nbsp;&nbsp;<SPAN class="keyword">[]</SPAN>&nbsp;error(connection(_&nbsp;_)&nbsp;&nbsp;debug:_)&nbsp;&nbsp;<SPAN class="keyword">then</SPAN>&nbsp;{Show&nbsp;connectionfailed}<BR>&nbsp;&nbsp;&nbsp;<SPAN class="keyword">end</SPAN>&nbsp;&nbsp;&nbsp;&nbsp;<BR>&nbsp;&nbsp;&nbsp;LocalStore&nbsp;NewObjInStore&nbsp;Movehere<BR>&nbsp;&nbsp;&nbsp;<SPAN class="keyword">try</SPAN>&nbsp;<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{LS&nbsp;newLocal(Module&nbsp;user1&nbsp;&nbsp;?NewObjInStore&nbsp;?LocalStore&nbsp;?Movehere)}<BR>&nbsp;&nbsp;&nbsp;<SPAN class="keyword">catch</SPAN>&nbsp;gs(connectionfailed)<BR>&nbsp;&nbsp;&nbsp;<SPAN class="keyword">then</SPAN>&nbsp;<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{Show&nbsp;connectionfailed}<BR>&nbsp;&nbsp;&nbsp;<SPAN class="keyword">end</SPAN>&nbsp;<BR>&nbsp;&nbsp;&nbsp;{Delay&nbsp;15000}<BR>&nbsp;&nbsp;&nbsp;<SPAN class="comment">%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%<BR></SPAN>&nbsp;&nbsp;&nbsp;<SPAN class="comment">%%&nbsp;Create&nbsp;an&nbsp;object&nbsp;in&nbsp;the&nbsp;store<BR></SPAN>&nbsp;&nbsp;&nbsp;<SPAN class="comment">%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%<BR></SPAN>&nbsp;&nbsp;&nbsp;Obj1&nbsp;Obj2&nbsp;Obj3&nbsp;&nbsp;<BR>&nbsp;&nbsp;&nbsp;Obj3={NewObjInStore&nbsp;&nbsp;Counter&nbsp;init(0)}<BR>&nbsp;&nbsp;&nbsp;Obj2={NewObjInStore&nbsp;&nbsp;Counter&nbsp;init(0)}<BR>&nbsp;&nbsp;&nbsp;<SPAN class="comment">%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%<BR></SPAN>&nbsp;&nbsp;&nbsp;<SPAN class="comment">%%%&nbsp;Get&nbsp;the&nbsp;local&nbsp;reference&nbsp;of&nbsp;an&nbsp;object<BR></SPAN>&nbsp;&nbsp;&nbsp;<SPAN class="comment">%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%<BR></SPAN>&nbsp;&nbsp;&nbsp;<SPAN class="keyword">try</SPAN>&nbsp;<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{LocalStore&nbsp;getobj(<SPAN class="string">'/usr/staff/ila/=Oz/store/o1globalref'</SPAN>&nbsp;?Obj1)}<BR>&nbsp;&nbsp;&nbsp;&nbsp;<BR>&nbsp;&nbsp;&nbsp;<SPAN class="keyword">catch</SPAN>&nbsp;<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;gs(objectlost)&nbsp;<SPAN class="keyword">then</SPAN>&nbsp;{Show&nbsp;<SPAN class="string">'object&nbsp;lost'</SPAN>}<BR>&nbsp;&nbsp;&nbsp;<SPAN class="keyword">[]</SPAN>&nbsp;&nbsp;error(url(_&nbsp;_)&nbsp;debug:_)&nbsp;<SPAN class="keyword">then</SPAN>&nbsp;{Show&nbsp;<SPAN class="string">'url&nbsp;or&nbsp;file&nbsp;not&nbsp;found'</SPAN>}<BR>&nbsp;&nbsp;&nbsp;<SPAN class="keyword">[]</SPAN>&nbsp;error(connection(_&nbsp;_)&nbsp;&nbsp;debug:_)&nbsp;&nbsp;<SPAN class="keyword">then</SPAN>&nbsp;{Show&nbsp;<SPAN class="string">'connection&nbsp;Module&nbsp;error'</SPAN>}<BR>&nbsp;&nbsp;&nbsp;<SPAN class="keyword">end</SPAN>&nbsp;&nbsp;&nbsp;&nbsp;<BR>&nbsp;&nbsp;&nbsp;&nbsp;<BR>&nbsp;&nbsp;&nbsp;<SPAN class="comment">%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%<BR></SPAN>&nbsp;&nbsp;&nbsp;<SPAN class="comment">%&nbsp;Procedure&nbsp;to&nbsp;show&nbsp;a&nbsp;coherent<BR></SPAN>&nbsp;&nbsp;&nbsp;<SPAN class="comment">%&nbsp;snapshot&nbsp;of&nbsp;the&nbsp;global&nbsp;store<BR></SPAN>&nbsp;&nbsp;&nbsp;<SPAN class="comment">%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%<BR></SPAN>&nbsp;&nbsp;&nbsp;CoherentSnapshot<BR>&nbsp;&nbsp;&nbsp;<SPAN class="keyword">proc</SPAN><SPAN class="variablename">&nbsp;</SPAN>{<SPAN class="functionname">CoherentSnapshot</SPAN>}<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;C={NewCell&nbsp;0}<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<SPAN class="keyword">proc</SPAN>{<SPAN class="functionname">Trans</SPAN>&nbsp;Output}<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Val1&nbsp;Val2&nbsp;Val3&nbsp;<SPAN class="keyword">in</SPAN>&nbsp;<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{Obj1&nbsp;show(Val1)}&nbsp;&nbsp;<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{Obj2&nbsp;show(Val2)}<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{Obj3&nbsp;show(Val3)}<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Output=state(Val1&nbsp;Val2&nbsp;Val3)<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<SPAN class="keyword">end</SPAN>&nbsp;<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Trid<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Out<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Res<BR>&nbsp;&nbsp;&nbsp;&nbsp;<SPAN class="keyword">in</SPAN>&nbsp;<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<SPAN class="comment">%&nbsp;State&nbsp;of&nbsp;objects&nbsp;Obj1&nbsp;Obj2&nbsp;is&nbsp;coherent&nbsp;here<BR></SPAN>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<SPAN class="comment">%&nbsp;show&nbsp;&nbsp;state&nbsp;of&nbsp;&nbsp;objects&nbsp;in&nbsp;a&nbsp;file&nbsp;after&nbsp;1mn&nbsp;of&nbsp;period<BR></SPAN>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<SPAN class="keyword">if</SPAN>&nbsp;{OS<SPAN class="keyword">.</SPAN>time&nbsp;&nbsp;$}&nbsp;<SPAN class="keyword">-</SPAN>&nbsp;{Access&nbsp;C&nbsp;$}<SPAN class="keyword">&gt;=</SPAN>20<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<SPAN class="keyword">then</SPAN>&nbsp;<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{LocalStore&nbsp;trans(Trans&nbsp;Out&nbsp;?Trid)}<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{LocalStore&nbsp;checktrans(Trid&nbsp;Res&nbsp;_)}&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<SPAN class="keyword">if</SPAN>&nbsp;Res<SPAN class="keyword">==</SPAN>commit&nbsp;&nbsp;<SPAN class="keyword">then</SPAN>&nbsp;<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{Show&nbsp;<SPAN class="string">'Obj1:'</SPAN><SPAN class="keyword">#</SPAN>Out<SPAN class="keyword">.</SPAN>1<SPAN class="keyword">#</SPAN><SPAN class="string">'Obj2:'</SPAN><SPAN class="keyword">#</SPAN>Out<SPAN class="keyword">.</SPAN>2<SPAN class="keyword">#</SPAN><SPAN class="string">'Obj3:'</SPAN><SPAN class="keyword">#</SPAN>Out<SPAN class="keyword">.</SPAN>3}<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<SPAN class="keyword">else</SPAN>&nbsp;<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<SPAN class="keyword">skip</SPAN>&nbsp;<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<SPAN class="keyword">end</SPAN>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{Assign&nbsp;C&nbsp;{OS<SPAN class="keyword">.</SPAN>time&nbsp;&nbsp;$}}<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<SPAN class="keyword">else</SPAN>&nbsp;<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<SPAN class="keyword">skip</SPAN>&nbsp;<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<SPAN class="keyword">end</SPAN>&nbsp;<BR>&nbsp;&nbsp;&nbsp;<SPAN class="keyword">end</SPAN>&nbsp;&nbsp;&nbsp;&nbsp;<BR>&nbsp;&nbsp;&nbsp;<SPAN class="comment">%%%%%%%%%%%%%%%%%%%<BR></SPAN>&nbsp;&nbsp;&nbsp;<SPAN class="comment">%&nbsp;Init&nbsp;transactions&nbsp;&nbsp;<BR></SPAN>&nbsp;&nbsp;&nbsp;<SPAN class="comment">%%%%%%%%%%%%%%%%%%%<BR></SPAN>&nbsp;&nbsp;&nbsp;Transset&nbsp;Iterate&nbsp;&nbsp;<BR>&nbsp;&nbsp;&nbsp;<SPAN class="keyword">fun</SPAN><SPAN class="variablename">&nbsp;&nbsp;</SPAN>{<SPAN class="functionname">Iterate</SPAN>&nbsp;I}<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Transid&nbsp;Iteratebis&nbsp;Retransid&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<SPAN class="keyword">proc</SPAN>{<SPAN class="functionname">Trans</SPAN>&nbsp;Out}<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<SPAN class="keyword">proc</SPAN><SPAN class="variablename">&nbsp;&nbsp;</SPAN>{<SPAN class="functionname">Iteratebis</SPAN>&nbsp;J}<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<SPAN class="keyword">if</SPAN>&nbsp;J<SPAN class="keyword">\=</SPAN>0<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<SPAN class="keyword">then</SPAN>&nbsp;&nbsp;<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{Obj1&nbsp;inc(1)&nbsp;}<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{Obj2&nbsp;inc(<SPAN class="keyword">~</SPAN>1)}<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{Iteratebis&nbsp;J<SPAN class="keyword">-</SPAN>1}&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<SPAN class="keyword">else</SPAN>&nbsp;<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<SPAN class="keyword">skip</SPAN>&nbsp;<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<SPAN class="keyword">end</SPAN>&nbsp;<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<SPAN class="keyword">end</SPAN>&nbsp;<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<SPAN class="keyword">in</SPAN>&nbsp;<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<SPAN class="comment">%{LocalStore&nbsp;waitlocks([Obj1&nbsp;Obj3])}&nbsp;&nbsp;<BR></SPAN>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<SPAN class="comment">%{LocalStore&nbsp;newthread(proc&nbsp;{$}&nbsp;{Show&nbsp;'newthread'}&nbsp;{Obj1&nbsp;inc(1)}&nbsp;end)}&nbsp;&nbsp;&nbsp;&nbsp;<BR></SPAN>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{Iteratebis&nbsp;1}<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{Obj1&nbsp;inc(1)&nbsp;}<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{Obj1&nbsp;inc(<SPAN class="keyword">~</SPAN>1)&nbsp;}<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{Obj1&nbsp;inc(1)&nbsp;}<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{Obj1&nbsp;inc(<SPAN class="keyword">~</SPAN>1)&nbsp;}<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{Obj1&nbsp;inc(1)&nbsp;}<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{Obj3&nbsp;inc(1)&nbsp;}&nbsp;&nbsp;<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<SPAN class="keyword">end</SPAN>&nbsp;<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Out&nbsp;&nbsp;<BR>&nbsp;&nbsp;&nbsp;<SPAN class="keyword">in</SPAN>&nbsp;<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<SPAN class="keyword">if</SPAN>&nbsp;I<SPAN class="keyword">\=</SPAN>0<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<SPAN class="keyword">then</SPAN>&nbsp;<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{LocalStore&nbsp;trans(Trans&nbsp;Out&nbsp;Transid)}<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{Delay&nbsp;60}<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Transid<SPAN class="keyword">#</SPAN>Transid<SPAN class="keyword">|</SPAN>{Iterate&nbsp;I<SPAN class="keyword">-</SPAN>1}<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<SPAN class="keyword">else</SPAN>&nbsp;<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;nil<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<SPAN class="keyword">end</SPAN>&nbsp;&nbsp;<BR>&nbsp;&nbsp;&nbsp;<SPAN class="keyword">end</SPAN>&nbsp;<BR>&nbsp;&nbsp;&nbsp;Transset={Iterate&nbsp;1000}&nbsp;&nbsp;&nbsp;&nbsp;<BR>&nbsp;&nbsp;&nbsp;<SPAN class="comment">%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%<BR></SPAN>&nbsp;&nbsp;&nbsp;<SPAN class="comment">%%&nbsp;Compute&nbsp;number&nbsp;of&nbsp;committed/aborted&nbsp;transactions<BR></SPAN>&nbsp;&nbsp;&nbsp;<SPAN class="comment">%%&nbsp;Wait&nbsp;for&nbsp;the&nbsp;end&nbsp;of&nbsp;transactions&nbsp;and&nbsp;updates&nbsp;..<BR></SPAN>&nbsp;&nbsp;&nbsp;<SPAN class="comment">%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%<BR></SPAN>&nbsp;&nbsp;&nbsp;{Wait&nbsp;{LocalStore&nbsp;termination($)}}&nbsp;<SPAN class="comment">%&nbsp;&nbsp;&nbsp;<BR></SPAN>&nbsp;&nbsp;&nbsp;Ccommit={NewCell&nbsp;0}&nbsp;Cabort={NewCell&nbsp;0}&nbsp;Crcommit={NewCell&nbsp;0}<BR>&nbsp;&nbsp;&nbsp;Crabort={NewCell&nbsp;0}&nbsp;&nbsp;<BR>&nbsp;&nbsp;&nbsp;Crecompute={NewCell&nbsp;0}&nbsp;Crrecompute={NewCell&nbsp;0}<BR>&nbsp;&nbsp;&nbsp;{ForAll&nbsp;Transset&nbsp;&nbsp;<BR>&nbsp;&nbsp;&nbsp;&nbsp;<SPAN class="keyword">proc</SPAN>{<SPAN class="functionname">$</SPAN>&nbsp;Pair}<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Tr&nbsp;RTr&nbsp;Res&nbsp;Resb&nbsp;Nb&nbsp;Nbr&nbsp;<SPAN class="keyword">in</SPAN>&nbsp;<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<SPAN class="keyword">if</SPAN>&nbsp;Pair<SPAN class="keyword">\=</SPAN>nil&nbsp;<SPAN class="keyword">then</SPAN>&nbsp;<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Pair=Tr<SPAN class="keyword">#</SPAN>RTr<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{LocalStore&nbsp;checktrans(Tr&nbsp;Res&nbsp;Nb)}<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{Assign&nbsp;Crecompute&nbsp;&nbsp;{Access&nbsp;Crecompute&nbsp;&nbsp;$}<SPAN class="keyword">+</SPAN>Nb}&nbsp;&nbsp;&nbsp;<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<SPAN class="keyword">if</SPAN>&nbsp;&nbsp;Res<SPAN class="keyword">==</SPAN>commit<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<SPAN class="keyword">then</SPAN>&nbsp;<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{Assign&nbsp;Ccommit&nbsp;{Access&nbsp;Ccommit&nbsp;&nbsp;$}<SPAN class="keyword">+</SPAN>1}<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<SPAN class="keyword">else</SPAN>&nbsp;<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{Assign&nbsp;Cabort&nbsp;{Access&nbsp;Cabort&nbsp;$}<SPAN class="keyword">+</SPAN>1}<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<SPAN class="keyword">end</SPAN>&nbsp;<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<SPAN class="keyword">if</SPAN>&nbsp;{Access&nbsp;Ccommit&nbsp;&nbsp;$}<SPAN class="keyword">+</SPAN>{Access&nbsp;Cabort&nbsp;&nbsp;$}<SPAN class="keyword">==</SPAN>1000&nbsp;<SPAN class="keyword">then</SPAN>&nbsp;<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{Show&nbsp;<SPAN class="string">'Number&nbsp;of&nbsp;local&nbsp;committed&nbsp;transaction:'</SPAN><SPAN class="keyword">#</SPAN>{Access&nbsp;Ccommit&nbsp;&nbsp;$}}<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{Show&nbsp;<SPAN class="string">'Number&nbsp;of&nbsp;local&nbsp;aborted&nbsp;transaction:'</SPAN><SPAN class="keyword">#</SPAN>{Access&nbsp;Cabort&nbsp;&nbsp;$}}<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{Show&nbsp;<SPAN class="string">'Number&nbsp;of&nbsp;local&nbsp;recomputed&nbsp;transaction:'</SPAN><SPAN class="keyword">#</SPAN>{Access&nbsp;Crecompute&nbsp;&nbsp;$}}<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<SPAN class="keyword">else</SPAN>&nbsp;<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<SPAN class="keyword">skip</SPAN>&nbsp;<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<SPAN class="keyword">end</SPAN>&nbsp;<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{LocalStore&nbsp;checktrans(RTr&nbsp;Resb&nbsp;Nbr)}<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{Assign&nbsp;Crrecompute&nbsp;&nbsp;{Access&nbsp;Crrecompute&nbsp;&nbsp;$}<SPAN class="keyword">+</SPAN>Nbr}&nbsp;&nbsp;<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<SPAN class="keyword">if</SPAN>&nbsp;Resb<SPAN class="keyword">==</SPAN>commit<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<SPAN class="keyword">then</SPAN>&nbsp;<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{Assign&nbsp;Crcommit&nbsp;{Access&nbsp;Crcommit&nbsp;&nbsp;$}<SPAN class="keyword">+</SPAN>1}<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<SPAN class="keyword">else</SPAN>&nbsp;<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{Assign&nbsp;Crabort&nbsp;{Access&nbsp;Crabort&nbsp;$}<SPAN class="keyword">+</SPAN>1}<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<SPAN class="keyword">end</SPAN>&nbsp;<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<SPAN class="keyword">if</SPAN>&nbsp;{Access&nbsp;Crcommit&nbsp;&nbsp;$}<SPAN class="keyword">+</SPAN>{Access&nbsp;Crabort&nbsp;&nbsp;$}<SPAN class="keyword">==</SPAN>1000&nbsp;<SPAN class="keyword">then</SPAN>&nbsp;<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{Show&nbsp;<SPAN class="string">'Number&nbsp;of&nbsp;local&nbsp;aborted&nbsp;retrans&nbsp;:'</SPAN><SPAN class="keyword">#</SPAN>{Access&nbsp;Crabort&nbsp;&nbsp;$}}<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{Show&nbsp;<SPAN class="string">'Number&nbsp;of&nbsp;local&nbsp;committed&nbsp;retrans&nbsp;:'</SPAN><SPAN class="keyword">#</SPAN>{Access&nbsp;Crcommit&nbsp;&nbsp;$}}<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{Show&nbsp;<SPAN class="string">'Number&nbsp;of&nbsp;local&nbsp;recomputed&nbsp;retrans:'</SPAN><SPAN class="keyword">#</SPAN>{Access&nbsp;Crrecompute&nbsp;&nbsp;$}}<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<SPAN class="keyword">else</SPAN>&nbsp;<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<SPAN class="keyword">skip</SPAN>&nbsp;<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<SPAN class="keyword">end</SPAN>&nbsp;<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<SPAN class="keyword">else</SPAN>&nbsp;<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<SPAN class="keyword">skip</SPAN>&nbsp;<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<SPAN class="keyword">end</SPAN>&nbsp;<BR>&nbsp;&nbsp;&nbsp;&nbsp;<SPAN class="keyword">end</SPAN>&nbsp;<BR>&nbsp;&nbsp;&nbsp;}&nbsp;&nbsp;&nbsp;&nbsp;<BR>&nbsp;&nbsp;&nbsp;{CoherentSnapshot}<BR><SPAN class="keyword">end</SPAN>&nbsp;<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<BR></PRE></BLOCKQUOTE><P></P></DIV><DIV id="section.globalstore.magent"><H2><A name="section.globalstore.magent">5.3 Mobile agent application</A></H2><P>NOT YET COMPLETED </P></DIV></DIV><TABLE align="center" border="0" cellpadding="6" cellspacing="6" class="nav"><TR bgcolor="#DDDDDD"><TD><A href="node4.html#chapter.examples">&lt;&lt; Prev</A></TD><TD><A href="index.html">- Up -</A></TD><TD><A href="node6.html#chapter.simulate">Next &gt;&gt;</A></TD></TR></TABLE><HR><ADDRESS>Mostafa AL-Metwally, Ilies Alouini <BR><SPAN class="version">Version 1.2.0 (20010319)</SPAN></ADDRESS></BODY></HTML>
